name: Publish AUR Binary Package

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.33)'
        required: true
        type: string
  push:
    tags:
      - 'aur-bin-v*.*.*'   # ä»…åœ¨æ‰“ aur-bin tag æ—¶è§¦å‘ (aur-bin-v0.1.33)

jobs:
  publish-aur-bin:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: startsWith(github.ref, 'refs/tags/aur-bin-v') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/aur-bin-v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Publishing binary version: $VERSION"
      
      - name: Verify release and DEB file exist
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ” Checking if release desktop-v$VERSION exists..."
          
          # æ£€æŸ¥ GitHub release æ˜¯å¦å­˜åœ¨
          if ! curl -s -f "https://api.github.com/repos/${{ github.repository }}/releases/tags/desktop-v$VERSION" > /dev/null; then
            echo "âŒ Release desktop-v$VERSION not found. Please create a GitHub release first."
            exit 1
          fi
          
          # æ£€æŸ¥ DEB æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          DEB_URL="https://github.com/${{ github.repository }}/releases/download/desktop-v$VERSION/novel-editor_${VERSION}_amd64.deb"
          echo "ğŸ” Checking DEB file: $DEB_URL"
          if ! curl -s -f -I "$DEB_URL" > /dev/null; then
            echo "âŒ DEB file not found: $DEB_URL"
            exit 1
          fi
          
          echo "âœ… Release desktop-v$VERSION and DEB file found"
      
      - name: Prepare binary PKGBUILD
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd aur
          echo "ğŸ“ Preparing binary PKGBUILD for version $VERSION"
          
          # å¤åˆ¶ PKGBUILD-bin ä¸º PKGBUILD (ä¿æŒæºæ–‡ä»¶ä¸å˜)
          cp PKGBUILD-bin PKGBUILD
          
          # æ›´æ–°ç‰ˆæœ¬å·
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD
          
          # æ›´æ–° source URL
          sed -i "s|desktop-v.*\/novel-editor_.*_amd64\.deb|desktop-v$VERSION/novel-editor_${VERSION}_amd64.deb|" PKGBUILD
          
          # æ˜¾ç¤ºæ›´æ–°åçš„å†…å®¹
          echo "ğŸ“„ Updated PKGBUILD:"
          grep -E "^(pkgver|source)" PKGBUILD
      
      - name: Generate .SRCINFO using Docker
        run: |
          cd aur
          echo "ğŸ”¨ Generating .SRCINFO using Arch Linux container..."
          
          # ä½¿ç”¨ Arch Linux Docker å®¹å™¨ç”Ÿæˆ .SRCINFO
          docker run --rm -v "$(pwd):/workspace" -w /workspace archlinux:latest bash -c "
            pacman -Sy --noconfirm base-devel
            useradd -m builder
            chown -R builder:builder /workspace
            su builder -c 'makepkg --printsrcinfo > .SRCINFO'
          "
          
          echo "ğŸ“„ Generated .SRCINFO:"
          cat .SRCINFO
      
      - name: Test DEB extraction
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ§ª Testing DEB file extraction..."
          
          # ä¸‹è½½ DEB æ–‡ä»¶è¿›è¡Œæµ‹è¯•
          DEB_URL="https://github.com/${{ github.repository }}/releases/download/desktop-v$VERSION/novel-editor_${VERSION}_amd64.deb"
          curl -L -o test.deb "$DEB_URL"
          
          # æ£€æŸ¥ DEB åŒ…å†…å®¹
          echo "ğŸ“¦ DEB package contents:"
          ar t test.deb
          
          # æå–å¹¶æ£€æŸ¥æ•°æ®æ–‡ä»¶æ ¼å¼
          ar x test.deb
          if [ -f data.tar.xz ]; then
            echo "âœ… Found data.tar.xz"
          elif [ -f data.tar.gz ]; then
            echo "âœ… Found data.tar.gz"
          elif [ -f data.tar.zst ]; then
            echo "âœ… Found data.tar.zst"
          else
            echo "âŒ No supported data archive found"
            ls -la
            exit 1
          fi
          
          # æ¸…ç†æµ‹è¯•æ–‡ä»¶
          rm -f test.deb control.tar.* data.tar.* debian-binary
      
      - name: Validate PKGBUILD
        run: |
          cd aur
          echo "âœ… Validating PKGBUILD..."
          
          # æ£€æŸ¥ PKGBUILD è¯­æ³•
          bash -n PKGBUILD
          
          # ä½¿ç”¨ Docker éªŒè¯ PKGBUILD
          docker run --rm -v "$(pwd):/workspace" -w /workspace archlinux:latest bash -c "
            source PKGBUILD
            if [ -z \"\$pkgname\" ] || [ -z \"\$pkgver\" ] || [ -z \"\$pkgdesc\" ]; then
              echo 'âŒ PKGBUILD missing required fields'
              exit 1
            fi
            echo 'âœ… PKGBUILD validation passed'
          "
      
      - name: Check AUR credentials
        run: |
          if [ -z "${{ secrets.AUR_USERNAME }}" ] || [ -z "${{ secrets.AUR_EMAIL }}" ] || [ -z "${{ secrets.AUR_SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Missing AUR credentials. Please set AUR_USERNAME, AUR_EMAIL, and AUR_SSH_PRIVATE_KEY secrets."
            exit 1
          fi
          echo "âœ… AUR credentials found"
      
      - name: Publish to AUR (Binary Package)
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
        with:
          pkgname: novel-editor-bin
          pkgbuild: aur/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update novel-editor-bin to version ${{ steps.version.outputs.version }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519
          force_push: true
      
      - name: Create success comment
        if: success() && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            
            try {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: `ğŸ‰ **AUR äºŒè¿›åˆ¶åŒ…å‘å¸ƒæˆåŠŸï¼**
            
            **ç‰ˆæœ¬ï¼š** ${version}
            **åŒ…åï¼š** novel-editor-bin
            
            **å®‰è£…å‘½ä»¤ï¼ˆå¿«é€Ÿå®‰è£…ï¼Œæ— éœ€ç¼–è¯‘ï¼‰ï¼š**
            \`\`\`bash
            yay -S novel-editor-bin
            # æˆ–
            paru -S novel-editor-bin
            \`\`\`
            
            **ä¼˜åŠ¿ï¼š**
            - âœ… å¿«é€Ÿå®‰è£…ï¼ˆç›´æ¥ä½¿ç”¨é¢„ç¼–è¯‘çš„ DEB åŒ…ï¼‰
            - âœ… æ— éœ€æ„å»ºä¾èµ–ï¼ˆRustã€Bun ç­‰ï¼‰
            - âœ… å®‰è£…åŒ…åªæœ‰ ~6MB
            
            **AUR é¡µé¢ï¼š** https://aur.archlinux.org/packages/novel-editor-bin`
              });
            } catch (error) {
              console.log('æ— æ³•åˆ›å»ºè¯„è®ºï¼Œä½† AUR äºŒè¿›åˆ¶åŒ…å‘å¸ƒæˆåŠŸ:', error.message);
            }