name: Publish to AUR

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.33)'
        required: true
        type: string
  push:
    tags:
      - 'aur-v*.*.*'   # ä»…åœ¨æ‰“ aur tag æ—¶è§¦å‘ (aur-v0.1.33)

jobs:
  publish-aur:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: startsWith(github.ref, 'refs/tags/aur-v') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/aur-v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Publishing version: $VERSION"
      
      - name: Verify release exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ” Checking if release desktop-v$VERSION exists..."
          
          # æ£€æŸ¥ GitHub release æ˜¯å¦å­˜åœ¨ (ä½¿ç”¨ desktop-v å‰ç¼€)
          if ! curl -s -f "https://api.github.com/repos/${{ github.repository }}/releases/tags/desktop-v$VERSION" > /dev/null; then
            echo "âŒ Release desktop-v$VERSION not found. Please create a GitHub release first."
            echo "ğŸ’¡ Expected release tag: desktop-v$VERSION"
            exit 1
          fi
          
          echo "âœ… Release desktop-v$VERSION found"
      
      - name: Update PKGBUILD
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ“ Updating PKGBUILD to version $VERSION"
          
          # æ›´æ–°ç‰ˆæœ¬å·
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" aur/PKGBUILD
          
          # æ›´æ–° source URL
          sed -i "s|archive/refs/tags/desktop-v.*\.tar\.gz|archive/refs/tags/desktop-v$VERSION.tar.gz|" aur/PKGBUILD
          
          # æ˜¾ç¤ºæ›´æ–°åçš„å†…å®¹
          echo "ğŸ“„ Updated PKGBUILD:"
          grep -E "^(pkgver|source)" aur/PKGBUILD
      
      - name: Generate .SRCINFO using Docker
        run: |
          cd aur
          echo "ğŸ”¨ Generating .SRCINFO using Arch Linux container..."
          
          # ä½¿ç”¨ Arch Linux Docker å®¹å™¨ç”Ÿæˆ .SRCINFO
          docker run --rm -v "$(pwd):/workspace" -w /workspace archlinux:latest bash -c "
            pacman -Sy --noconfirm base-devel
            useradd -m builder
            chown -R builder:builder /workspace
            su builder -c 'makepkg --printsrcinfo > .SRCINFO'
          "
          
          echo "ğŸ“„ Generated .SRCINFO:"
          cat .SRCINFO
      
      - name: Validate PKGBUILD
        run: |
          cd aur
          echo "âœ… Validating PKGBUILD..."
          
          # æ£€æŸ¥ PKGBUILD è¯­æ³•
          bash -n PKGBUILD
          
          # ä½¿ç”¨ Docker éªŒè¯ PKGBUILD
          docker run --rm -v "$(pwd):/workspace" -w /workspace archlinux:latest bash -c "
            source PKGBUILD
            if [ -z \"\$pkgname\" ] || [ -z \"\$pkgver\" ] || [ -z \"\$pkgdesc\" ]; then
              echo 'âŒ PKGBUILD missing required fields'
              exit 1
            fi
            echo 'âœ… PKGBUILD validation passed'
          "
      
      - name: Check AUR credentials
        run: |
          if [ -z "${{ secrets.AUR_USERNAME }}" ] || [ -z "${{ secrets.AUR_EMAIL }}" ] || [ -z "${{ secrets.AUR_SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Missing AUR credentials. Please set AUR_USERNAME, AUR_EMAIL, and AUR_SSH_PRIVATE_KEY secrets."
            exit 1
          fi
          echo "âœ… AUR credentials found"
      
      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
        with:
          pkgname: novel-editor
          pkgbuild: aur/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update novel-editor to version ${{ steps.version.outputs.version }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519
          force_push: true
      
      - name: Create success comment
        if: success() && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            
            try {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: `ğŸ‰ **AUR å‘å¸ƒæˆåŠŸï¼**
            
            **ç‰ˆæœ¬ï¼š** ${version}
            **åŒ…åï¼š** novel-editor
            
            **å®‰è£…å‘½ä»¤ï¼š**
            \`\`\`bash
            yay -S novel-editor
            # æˆ–
            paru -S novel-editor
            \`\`\`
            
            **AUR é¡µé¢ï¼š** https://aur.archlinux.org/packages/novel-editor`
              });
            } catch (error) {
              console.log('æ— æ³•åˆ›å»ºè¯„è®ºï¼Œä½† AUR å‘å¸ƒæˆåŠŸ:', error.message);
            }
