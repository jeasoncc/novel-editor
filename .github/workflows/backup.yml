name: Backup Repository

on:
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨ 3 ç‚¹å¤‡ä»½
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  backup:
    name: Create Repository Backup
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²
      
      - name: Create backup archive
        run: |
          DATE=$(date +%Y%m%d)
          BACKUP_NAME="novel-editor-backup-$DATE"
          
          echo "ðŸ“¦ åˆ›å»ºå¤‡ä»½: $BACKUP_NAME"
          
          # åˆ›å»ºå®Œæ•´å¤‡ä»½ï¼ˆåŒ…æ‹¬ .gitï¼‰
          tar -czf "$BACKUP_NAME-full.tar.gz" \
            --exclude=node_modules \
            --exclude=.turbo \
            --exclude=dist \
            --exclude=out \
            --exclude=target \
            .
          
          # åˆ›å»ºæºç å¤‡ä»½ï¼ˆä¸åŒ…æ‹¬ .gitï¼‰
          tar -czf "$BACKUP_NAME-source.tar.gz" \
            --exclude=.git \
            --exclude=node_modules \
            --exclude=.turbo \
            --exclude=dist \
            --exclude=out \
            --exclude=target \
            .
          
          echo "âœ… å¤‡ä»½åˆ›å»ºå®Œæˆ"
          ls -lh *.tar.gz
      
      - name: Generate backup info
        run: |
          DATE=$(date +%Y-%m-%d)
          COMMIT=$(git rev-parse HEAD)
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          
          cat > backup-info.txt << EOF
          Novel Editor å¤‡ä»½ä¿¡æ¯
          =====================
          
          å¤‡ä»½æ—¥æœŸ: $DATE
          æäº¤å“ˆå¸Œ: $COMMIT
          åˆ†æ”¯: $BRANCH
          
          æ–‡ä»¶åˆ—è¡¨:
          - novel-editor-backup-$(date +%Y%m%d)-full.tar.gz (å®Œæ•´å¤‡ä»½ï¼ŒåŒ…å« Git åŽ†å²)
          - novel-editor-backup-$(date +%Y%m%d)-source.tar.gz (æºç å¤‡ä»½)
          
          æ¢å¤æ–¹æ³•:
          1. ä¸‹è½½å¤‡ä»½æ–‡ä»¶
          2. è§£åŽ‹: tar -xzf novel-editor-backup-*.tar.gz
          3. å®‰è£…ä¾èµ–: bun install
          4. æž„å»ºé¡¹ç›®: bun run build
          
          æ³¨æ„äº‹é¡¹:
          - å®Œæ•´å¤‡ä»½åŒ…å« Git åŽ†å²ï¼Œä½“ç§¯è¾ƒå¤§
          - æºç å¤‡ä»½ä»…åŒ…å«æºä»£ç ï¼Œä½“ç§¯è¾ƒå°
          - å¤‡ä»½ä¸åŒ…å« node_modules å’Œæž„å»ºäº§ç‰©
          EOF
          
          cat backup-info.txt
      
      - name: Upload backup artifacts
        uses: actions/upload-artifact@v5
        with:
          name: repository-backup-${{ github.run_number }}
          path: |
            *.tar.gz
            backup-info.txt
          retention-days: 90  # ä¿ç•™ 90 å¤©
      
      - name: Calculate backup size
        run: |
          FULL_SIZE=$(du -h *-full.tar.gz | cut -f1)
          SOURCE_SIZE=$(du -h *-source.tar.gz | cut -f1)
          
          echo "ðŸ“Š å¤‡ä»½å¤§å°:"
          echo "  - å®Œæ•´å¤‡ä»½: $FULL_SIZE"
          echo "  - æºç å¤‡ä»½: $SOURCE_SIZE"
      
      # å¯é€‰: ä¸Šä¼ åˆ°äº‘å­˜å‚¨
      # - name: Upload to cloud storage
      #   run: |
      #     # ç¤ºä¾‹: ä¸Šä¼ åˆ° AWS S3
      #     # aws s3 cp *.tar.gz s3://your-bucket/backups/
      #     
      #     # ç¤ºä¾‹: ä¸Šä¼ åˆ° Google Cloud Storage
      #     # gsutil cp *.tar.gz gs://your-bucket/backups/
      #     
      #     echo "äº‘å­˜å‚¨ä¸Šä¼ åŠŸèƒ½å¾…é…ç½®"
