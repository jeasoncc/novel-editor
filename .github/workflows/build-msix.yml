name: Build MSIX Package (cargo-packager)

on:
  workflow_dispatch:
  push:
    tags:
      - "desktop-v*.*.*"

jobs:
  build-msix:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4

      # 安装 Rust
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'apps/desktop/src-tauri -> target'

      # 安装 cargo-packager
      - name: Install cargo-packager
        run: cargo install cargo-packager --locked

      # 安装 Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # 安装依赖
      - name: Install dependencies
        run: |
          bun install
          cd apps/desktop
          bun install

      # 构建前端
      - name: Build frontend
        working-directory: apps/desktop
        run: bun run build

      # 使用 cargo-packager 构建 MSIX
      - name: Build MSIX with cargo-packager
        working-directory: apps/desktop/src-tauri
        shell: pwsh
        run: |
          Write-Output "使用 cargo-packager 构建 MSIX..."
          
          # 构建 MSIX（注意：格式是 msix 不是 app）
          cargo packager --release --formats msix
          
          Write-Output "MSIX 构建完成"
          
          # 列出生成的文件
          Write-Output "查找生成的 MSIX 文件..."
          Get-ChildItem -Path "target/release" -Recurse -Include "*.msix" | ForEach-Object {
            Write-Output "找到 MSIX: $($_.FullName)"
            Write-Output "文件大小: $([math]::Round($_.Length / 1MB, 2)) MB"
          }

      # 签名 MSIX（使用自签名证书）
      - name: Sign MSIX
        shell: pwsh
        run: |
          # 查找生成的 MSIX 文件
          Write-Output "查找 MSIX 文件..."
          $msixFiles = Get-ChildItem -Path "apps/desktop/src-tauri/target/release" -Recurse -Include "*.msix" -ErrorAction SilentlyContinue
          
          if ($null -eq $msixFiles -or $msixFiles.Count -eq 0) {
            Write-Error "未找到 MSIX 文件，构建可能失败"
            exit 1
          }
          
          Write-Output "找到 $($msixFiles.Count) 个 MSIX 文件"
          
          # 创建自签名证书
          Write-Output "创建自签名证书..."
          $cert = New-SelfSignedCertificate -Type Custom -Subject "CN=Lotus" `
            -KeyUsage DigitalSignature -FriendlyName "Novel Editor" `
            -CertStoreLocation "Cert:\CurrentUser\My" `
            -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
          
          $password = ConvertTo-SecureString -String "temp123" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath "temp-cert.pfx" -Password $password | Out-Null
          Write-Output "证书创建成功"
          
          # 查找 SignTool
          Write-Output "查找 SignTool..."
          $signTool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue | 
                      Where-Object { $_.FullName -like "*\x64\*" } | 
                      Select-Object -First 1 -ExpandProperty FullName
          
          if (-not $signTool) {
            Write-Error "未找到 SignTool，无法签名 MSIX"
            exit 1
          }
          
          Write-Output "找到 SignTool: $signTool"
          
          # 签名所有 MSIX 文件
          foreach ($msix in $msixFiles) {
            Write-Output "正在签名: $($msix.Name)"
            & $signTool sign /fd SHA256 /a /f "temp-cert.pfx" /p "temp123" $msix.FullName
            
            if ($LASTEXITCODE -eq 0) {
              Write-Output "✓ 签名成功: $($msix.Name)"
            } else {
              Write-Error "✗ 签名失败: $($msix.Name)"
              exit 1
            }
          }

      # 复制 MSIX 到根目录
      - name: Copy MSIX files
        shell: pwsh
        run: |
          Write-Output "查找并复制 MSIX 文件..."
          $msixFiles = Get-ChildItem -Path "apps/desktop/src-tauri/target/release" -Recurse -Include "*.msix" -ErrorAction SilentlyContinue
          
          if ($null -eq $msixFiles -or $msixFiles.Count -eq 0) {
            Write-Error "未找到 MSIX 文件"
            exit 1
          }
          
          # 读取版本号
          $config = Get-Content 'apps/desktop/src-tauri/tauri.conf.json' | ConvertFrom-Json
          $version = $config.version
          
          foreach ($msix in $msixFiles) {
            $destName = "novel-editor_${version}_x64.msix"
            Copy-Item $msix.FullName $destName -Force
            Write-Output "✓ 复制: $($msix.Name) -> $destName"
            
            # 显示文件信息
            $fileInfo = Get-Item $destName
            Write-Output "  文件大小: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
          }

      # 上传 MSIX 产物
      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: msix-package
          path: "*.msix"
          if-no-files-found: warn

      # 发布到 GitHub Release
      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: "*.msix"
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
