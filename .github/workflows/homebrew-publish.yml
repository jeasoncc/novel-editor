name: Publish to Homebrew

# ä¾èµ– desktop æ„å»ºå®Œæˆï¼ˆéœ€è¦ DMG æ–‡ä»¶ï¼‰ï¼Œåªé€šè¿‡ workflow_dispatch è§¦å‘
# desktop å®Œæˆåä¼šè‡ªåŠ¨è§¦å‘æ­¤å·¥ä½œæµ
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.53)'
        required: true
        type: string

jobs:
  publish-homebrew:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/homebrew-v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Creating Homebrew cask for version: $VERSION"

      - name: Verify release and get download info
        id: release_info
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_URL="https://api.github.com/repos/${{ github.repository }}/releases/tags/desktop-v$VERSION"
          
          echo "ğŸ” Checking release: desktop-v$VERSION"
          
          # è·å– release ä¿¡æ¯
          RESPONSE=$(curl -s "$RELEASE_URL")
          
          # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ° release
          if echo "$RESPONSE" | jq -e '.message == "Not Found"' > /dev/null 2>&1; then
            echo "âŒ Release desktop-v$VERSION not found"
            echo ""
            echo "ğŸ“‹ To fix this:"
            echo "1. Create desktop release first: npm run tag:desktop"
            echo "2. Wait for build to complete"
            echo "3. Then retry Homebrew publish"
            exit 1
          fi
          
          echo "âœ… Release found"
          
          # æ£€æŸ¥ assets æ˜¯å¦å­˜åœ¨
          ASSETS_COUNT=$(echo "$RESPONSE" | jq '.assets | length // 0')
          if [ "$ASSETS_COUNT" -eq 0 ]; then
            echo "âŒ No assets found in release"
            echo "Release may still be building. Please wait and retry."
            exit 1
          fi
          
          echo "ğŸ“¦ Found $ASSETS_COUNT assets in release"
          echo "Available assets:"
          echo "$RESPONSE" | jq -r '.assets[].name // empty'
          
          # æŸ¥æ‰¾ macOS DMG æ–‡ä»¶ï¼ˆä¼˜å…ˆ Apple Siliconï¼Œç„¶å Intelï¼‰
          ARM_DMG=$(echo "$RESPONSE" | jq -r '[.assets[] | select(.name | test("aarch64.*\\.dmg$"; "i")) | .browser_download_url][0] // empty')
          INTEL_DMG=$(echo "$RESPONSE" | jq -r '[.assets[] | select(.name | test("x64.*\\.dmg$"; "i")) | .browser_download_url][0] // empty')
          
          if [ -n "$ARM_DMG" ]; then
            DOWNLOAD_URL="$ARM_DMG"
            ARCH="arm64"
            echo "âœ… Found Apple Silicon DMG: $DOWNLOAD_URL"
          elif [ -n "$INTEL_DMG" ]; then
            DOWNLOAD_URL="$INTEL_DMG"
            ARCH="intel"
            echo "âœ… Found Intel DMG: $DOWNLOAD_URL"
          else
            echo "âŒ No macOS DMG files found in release"
            echo ""
            echo "ğŸ“‹ This workflow requires macOS DMG files."
            echo "Make sure the desktop release includes macOS builds."
            exit 1
          fi
          
          # ä¸‹è½½æ–‡ä»¶è®¡ç®— SHA256
          FILE_NAME=$(basename "$DOWNLOAD_URL")
          echo "ğŸ“¥ Downloading $FILE_NAME to calculate SHA256..."
          curl -L -o "$FILE_NAME" "$DOWNLOAD_URL"
          
          SHA256=$(shasum -a 256 "$FILE_NAME" | cut -d' ' -f1)
          rm "$FILE_NAME"
          
          echo "âœ… SHA256: $SHA256"
          
          # è¾“å‡ºå˜é‡
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "arch=$ARCH" >> $GITHUB_OUTPUT
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT

      - name: Create Homebrew Cask
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DOWNLOAD_URL="${{ steps.release_info.outputs.download_url }}"
          SHA256="${{ steps.release_info.outputs.sha256 }}"
          ARCH="${{ steps.release_info.outputs.arch }}"
          
          # åˆ›å»º cask ç›®å½•
          mkdir -p homebrew-cask
          
          # åˆ›å»º Cask æ–‡ä»¶
          cat > homebrew-cask/novel-editor.rb << EOF
          cask "novel-editor" do
            version "$VERSION"
            sha256 "$SHA256"
          
            url "https://github.com/${{ github.repository }}/releases/download/desktop-v#{version}/novel-editor_#{version}_aarch64.dmg",
                verified: "github.com/${{ github.repository }}/"
            name "Novel Editor"
            desc "Modern, powerful novel writing application for serious writers"
            homepage "https://github.com/${{ github.repository }}"
          
            livecheck do
              url :url
              regex(/desktop-v?(\d+(?:\.\d+)+)/i)
            end
          
            app "novel-editor.app"
          
            zap trash: [
              "~/Library/Application Support/com.lotus.novel-editor",
              "~/Library/Caches/com.lotus.novel-editor",
              "~/Library/Preferences/com.lotus.novel-editor.plist",
              "~/Library/Saved Application State/com.lotus.novel-editor.savedState",
              "~/Library/WebKit/com.lotus.novel-editor",
            ]
          end
          EOF
          
          echo "âœ… Homebrew Cask created"
          echo ""
          echo "ğŸ“„ Cask content:"
          cat homebrew-cask/novel-editor.rb

      - name: Install Homebrew and test cask
        run: |
          echo "ğŸ§ª Testing Homebrew cask..."
          
          # ç¡®ä¿ Homebrew å·²å®‰è£…
          if ! command -v brew &> /dev/null; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          
          # éªŒè¯ cask è¯­æ³•ï¼ˆä½¿ç”¨æ–°çš„å‘½ä»¤æ ¼å¼ï¼‰
          echo "Validating cask syntax..."
          brew style --cask homebrew-cask/novel-editor.rb || echo "Style check completed (warnings are acceptable)"
          
          # éªŒè¯ Ruby è¯­æ³•
          ruby -c homebrew-cask/novel-editor.rb
          
          echo "âœ… Cask syntax validation passed"

      - name: Create PR to Homebrew Cask repository
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "ğŸº Preparing Homebrew Cask submission..."
          
          # é…ç½® git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # å…‹éš† homebrew-cask ä»“åº“
          echo "ğŸ“¥ Cloning homebrew-cask repository..."
          git clone https://github.com/Homebrew/homebrew-cask.git
          cd homebrew-cask
          
          # åˆ›å»ºæ–°åˆ†æ”¯
          BRANCH_NAME="novel-editor-$VERSION"
          git checkout -b "$BRANCH_NAME"
          
          # å¤åˆ¶ cask æ–‡ä»¶
          cp ../homebrew-cask/novel-editor.rb Casks/n/novel-editor.rb
          
          # æäº¤æ›´æ”¹
          git add Casks/n/novel-editor.rb
          git commit -m "Add novel-editor $VERSION"
          
          echo "âœ… Prepared Homebrew Cask update"
          echo ""
          echo "ğŸ“‹ Next steps (manual):"
          echo "1. Fork https://github.com/Homebrew/homebrew-cask"
          echo "2. Add the cask file to Casks/n/ directory"
          echo "3. Create PR with title: 'Add novel-editor $VERSION'"
          echo ""
          echo "ğŸ“„ Cask file ready in artifacts"

      - name: Upload Homebrew Cask artifact
        uses: actions/upload-artifact@v4
        with:
          name: homebrew-cask
          path: "homebrew-cask/novel-editor.rb"
          retention-days: 30

      - name: Create success summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ steps.release_info.outputs.arch }}"
          
          echo ""
          echo "ğŸ‰ Homebrew Cask Summary"
          echo "========================"
          echo "âœ… Version: $VERSION"
          echo "âœ… Architecture: $ARCH"
          echo "âœ… Cask: novel-editor.rb"
          echo "âœ… SHA256 verified"
          echo ""
          echo "ğŸ“¦ Installation command (after approval):"
          echo "   brew install --cask novel-editor"
          echo ""
          echo "ğŸ”— Repository:"
          echo "   https://github.com/Homebrew/homebrew-cask"
          echo ""
          echo "ğŸ“‹ Manual submission:"
          echo "1. Download cask from artifacts"
          echo "2. Fork Homebrew/homebrew-cask"
          echo "3. Add to Casks/n/ directory"
          echo "4. Create PR"