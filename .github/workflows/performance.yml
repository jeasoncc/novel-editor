name: Performance Monitoring

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/web/**'
  schedule:
    # æ¯å‘¨è¿è¡Œä¸€æ¬¡æ€§èƒ½æµ‹è¯•
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  lighthouse:
    name: Lighthouse Performance Test
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Build web app
        working-directory: apps/web
        run: bun run build
      
      - name: Serve built app
        working-directory: apps/web
        run: |
          npx serve out -l 3000 &
          sleep 5
      
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            http://localhost:3000
          uploadArtifacts: true
          temporaryPublicStorage: true
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const comment = `
            ## âš¡ Lighthouse æ€§èƒ½æŠ¥å‘Š
            
            æ€§èƒ½æµ‹è¯•å·²å®Œæˆï¼æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šè¯·ç‚¹å‡»ä¸Šæ–¹çš„ Artifactsã€‚
            
            ### å…³é”®æŒ‡æ ‡
            - Performance: æŸ¥çœ‹æŠ¥å‘Š
            - Accessibility: æŸ¥çœ‹æŠ¥å‘Š
            - Best Practices: æŸ¥çœ‹æŠ¥å‘Š
            - SEO: æŸ¥çœ‹æŠ¥å‘Š
            
            ðŸ’¡ æç¤º: ç¡®ä¿æ‰€æœ‰æŒ‡æ ‡éƒ½åœ¨ 90 åˆ†ä»¥ä¸Š
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  build-time:
    name: Build Time Tracking
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Measure web build time
        working-directory: apps/web
        run: |
          echo "ðŸ“Š æµ‹é‡ Web æž„å»ºæ—¶é—´..."
          START_TIME=$(date +%s)
          bun run build
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          echo "WEB_BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          echo "âœ… Web æž„å»ºæ—¶é—´: ${BUILD_TIME}s"
      
      - name: Measure desktop build time
        working-directory: apps/desktop
        run: |
          echo "ðŸ“Š æµ‹é‡ Desktop æž„å»ºæ—¶é—´..."
          START_TIME=$(date +%s)
          bun run build
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          echo "DESKTOP_BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          echo "âœ… Desktop æž„å»ºæ—¶é—´: ${BUILD_TIME}s"
      
      - name: Generate report
        run: |
          echo "## â±ï¸ æž„å»ºæ—¶é—´æŠ¥å‘Š" > build-time-report.md
          echo "" >> build-time-report.md
          echo "- **Web æž„å»º**: ${WEB_BUILD_TIME}s" >> build-time-report.md
          echo "- **Desktop æž„å»º**: ${DESKTOP_BUILD_TIME}s" >> build-time-report.md
          echo "- **æ€»è®¡**: $((WEB_BUILD_TIME + DESKTOP_BUILD_TIME))s" >> build-time-report.md
          echo "" >> build-time-report.md
          
          if [ $WEB_BUILD_TIME -gt 60 ]; then
            echo "âš ï¸ Web æž„å»ºæ—¶é—´è¶…è¿‡ 60 ç§’ï¼Œå»ºè®®ä¼˜åŒ–" >> build-time-report.md
          fi
          
          if [ $DESKTOP_BUILD_TIME -gt 60 ]; then
            echo "âš ï¸ Desktop æž„å»ºæ—¶é—´è¶…è¿‡ 60 ç§’ï¼Œå»ºè®®ä¼˜åŒ–" >> build-time-report.md
          fi
      
      - name: Upload report
        uses: actions/upload-artifact@v5
        with:
          name: build-time-report
          path: build-time-report.md
