name: Publish to Debian PPA

# ‰æùËµñ desktop ÊûÑÂª∫ÂÆåÊàêÔºàÈúÄË¶Å DEB Êñá‰ª∂ÔºâÔºåÂè™ÈÄöËøá workflow_dispatch Ëß¶Âèë
# desktop ÂÆåÊàêÂêé‰ºöËá™Âä®Ëß¶ÂèëÊ≠§Â∑•‰ΩúÊµÅ
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.53)'
        required: true
        type: string

jobs:
  publish-ppa:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Creating PPA package for version: $VERSION"

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            devscripts \
            debhelper \
            dh-make \
            build-essential \
            lintian \
            fakeroot \
            gpg \
            dput

      - name: Setup GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          # ÈÖçÁΩÆ GPG ‰∏∫Èùû‰∫§‰∫íÊ®°Âºè
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "use-agent" >> ~/.gnupg/gpg.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent || true
          
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "‚ö† GPG_PRIVATE_KEY not set, will build unsigned package"
            echo "SKIP_SIGNING=true" >> $GITHUB_ENV
          else
            echo "$GPG_PRIVATE_KEY" | gpg --batch --import
            GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk -F'/' '{print $2}' | awk '{print $1}')
            echo "GPG_KEY_ID=$GPG_KEY_ID" >> $GITHUB_ENV
            echo "GPG_PASSPHRASE=$GPG_PASSPHRASE" >> $GITHUB_ENV
            echo "SKIP_SIGNING=false" >> $GITHUB_ENV
            echo "‚úÖ GPG key configured: $GPG_KEY_ID"
          fi

      - name: Verify DEB package exists
        id: deb_info
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_URL="https://api.github.com/repos/${{ github.repository }}/releases/tags/desktop-v$VERSION"
          
          echo "üîç Checking for DEB package in release desktop-v$VERSION"
          
          RESPONSE=$(curl -s "$RELEASE_URL")
          if echo "$RESPONSE" | jq -e '.message == "Not Found"' > /dev/null; then
            echo "‚ùå Release desktop-v$VERSION not found"
            echo ""
            echo "üìã To fix this:"
            echo "1. Create desktop release first: npm run tag:desktop"
            echo "2. Wait for build to complete"
            echo "3. Then retry PPA publish"
            exit 1
          fi
          
          # Êü•Êâæ DEB Êñá‰ª∂
          DEB_URL=$(echo "$RESPONSE" | jq -r '.assets[] | select(.name | contains(".deb")) | .browser_download_url' | head -1)
          
          if [ -z "$DEB_URL" ] || [ "$DEB_URL" = "null" ]; then
            echo "‚ùå No DEB package found in release"
            exit 1
          fi
          
          DEB_NAME=$(basename "$DEB_URL")
          echo "‚úÖ Found DEB package: $DEB_NAME"
          echo "   URL: $DEB_URL"
          
          # ‰∏ãËΩΩ DEB ÂåÖ
          wget -O "$DEB_NAME" "$DEB_URL"
          
          echo "deb_url=$DEB_URL" >> $GITHUB_OUTPUT
          echo "deb_name=$DEB_NAME" >> $GITHUB_OUTPUT

      - name: Extract and prepare source package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DEB_NAME="${{ steps.deb_info.outputs.deb_name }}"
          
          # ÂàõÂª∫Â∑•‰ΩúÁõÆÂΩï
          WORK_DIR="novel-editor-$VERSION"
          mkdir -p "$WORK_DIR"
          cd "$WORK_DIR"
          
          # ÊèêÂèñ DEB ÂåÖÂÜÖÂÆπ
          ar x "../$DEB_NAME"
          tar -xf data.tar.*
          
          # ÂàõÂª∫Ê∫êÁ†ÅÁõÆÂΩïÁªìÊûÑ
          mkdir -p "novel-editor-$VERSION"
          
          # Â§çÂà∂Â∫îÁî®Êñá‰ª∂
          if [ -d "usr" ]; then
            cp -r usr "novel-editor-$VERSION/"
          fi
          
          cd "novel-editor-$VERSION"
          
          # ÂàõÂª∫ debian ÁõÆÂΩï
          mkdir -p debian
          
          # ÂàõÂª∫ debian/control
          cat > debian/control << EOF
          Source: novel-editor
          Section: editors
          Priority: optional
          Maintainer: Jeason <xiaomiquan@aliyun.com>
          Build-Depends: debhelper (>= 10)
          Standards-Version: 4.1.2
          Homepage: https://github.com/${{ github.repository }}
          
          Package: novel-editor
          Architecture: amd64
          Depends: \${shlibs:Depends}, \${misc:Depends}
          Description: A modern, powerful novel writing application
           Novel Editor is a professional writing tool designed specifically for
           novelists and long-form fiction writers. Built with modern technologies,
           it provides a distraction-free writing environment with powerful
           organizational features.
           .
           Features include rich text editing, chapter organization, character
           management, and export to multiple formats.
          EOF
          
          # ÂàõÂª∫ debian/changelog (‰ΩøÁî® jammy ‰Ωú‰∏∫ÁõÆÊ†áÂèëË°åÁâà)
          cat > debian/changelog << EOF
          novel-editor ($VERSION-1) jammy; urgency=medium
          
            * New upstream release $VERSION
            * See https://github.com/${{ github.repository }}/releases/tag/desktop-v$VERSION
          
           -- Jeason <xiaomiquan@aliyun.com>  $(date -R)
          EOF
          
          # ÂàõÂª∫ debian/copyright
          cat > debian/copyright << EOF
          Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
          Upstream-Name: novel-editor
          Source: https://github.com/${{ github.repository }}
          
          Files: *
          Copyright: 2024 Jeason
          License: MIT
          
          License: MIT
           Permission is hereby granted, free of charge, to any person obtaining a
           copy of this software and associated documentation files (the "Software"),
           to deal in the Software without restriction, including without limitation
           the rights to use, copy, modify, merge, publish, distribute, sublicense,
           and/or sell copies of the Software, and to permit persons to whom the
           Software is furnished to do so, subject to the following conditions:
           .
           The above copyright notice and this permission notice shall be included
           in all copies or substantial portions of the Software.
           .
           THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
           OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
           FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
           THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
           LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
           FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
           DEALINGS IN THE SOFTWARE.
          EOF
          
          # ÂàõÂª∫ debian/rules
          cat > debian/rules << 'EOF'
          #!/usr/bin/make -f
          
          %:
          	dh $@
          
          override_dh_auto_build:
          	# Skip build - we're packaging pre-built binaries
          
          override_dh_auto_install:
          	# Copy files to package directory
          	mkdir -p debian/novel-editor
          	cp -r usr debian/novel-editor/
          EOF
          
          chmod +x debian/rules
          
          # ÂàõÂª∫ debian/compat
          echo "10" > debian/compat
          
          # ÂàõÂª∫ debian/source/format (Ê∂àÈô§ lintian Ë≠¶Âëä)
          mkdir -p debian/source
          echo "3.0 (quilt)" > debian/source/format
          
          echo "‚úÖ Debian package structure created"

      - name: Build source package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd "novel-editor-$VERSION/novel-editor-$VERSION"
          
          # ÂàõÂª∫ÂéüÂßã tarball
          cd ..
          tar -czf "novel-editor_$VERSION.orig.tar.gz" "novel-editor-$VERSION"
          cd "novel-editor-$VERSION"
          
          # ÊûÑÂª∫Ê∫êÁ†ÅÂåÖ
          if [ "$SKIP_SIGNING" = "true" ]; then
            echo "‚ö† Building unsigned package (no GPG key configured)"
            dpkg-buildpackage -us -uc -S -sa
          else
            echo "üîê Building signed package with GPG key: $GPG_KEY_ID"
            # ‰ΩøÁî® debsign ÁöÑÈùû‰∫§‰∫íÊ®°Âºè
            export DEBSIGN_KEYID="$GPG_KEY_ID"
            export DEBSIGN_PROGRAM="gpg --batch --pinentry-mode loopback"
            
            # ÂÖàÊûÑÂª∫Êú™Á≠æÂêçÁöÑÂåÖ
            dpkg-buildpackage -us -uc -S -sa
            
            # ÁÑ∂ÂêéÊâãÂä®Á≠æÂêç
            cd ..
            if [ -n "$GPG_PASSPHRASE" ]; then
              echo "$GPG_PASSPHRASE" | gpg --batch --pinentry-mode loopback --passphrase-fd 0 --armor --detach-sign -u "$GPG_KEY_ID" "novel-editor_$VERSION-1.dsc" || echo "‚ö† DSC signing skipped"
            fi
          fi
          
          echo "‚úÖ Source package built"
          
          # ÂàóÂá∫ÁîüÊàêÁöÑÊñá‰ª∂
          cd ..
          ls -la *.dsc *.tar.* *.changes 2>/dev/null || ls -la

      - name: Test package with lintian
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd "novel-editor-$VERSION"
          
          # Ê£ÄÊü•Ê∫êÁ†ÅÂåÖ
          lintian -i *.changes || echo "‚ö† Lintian warnings found (non-fatal)"
          
          echo "‚úÖ Package validation completed"

      - name: Upload to PPA (Launchpad)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        env:
          LAUNCHPAD_PPA: ${{ secrets.LAUNCHPAD_PPA }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd "novel-editor-$VERSION"
          
          if [ -z "$LAUNCHPAD_PPA" ]; then
            echo "‚ö† LAUNCHPAD_PPA not set, skipping upload"
            echo ""
            echo "üìã To upload to PPA:"
            echo "1. Create Launchpad account and PPA"
            echo "2. Add LAUNCHPAD_PPA secret (format: ppa:username/ppaname)"
            echo "3. Add GPG_PRIVATE_KEY and GPG_PASSPHRASE secrets"
            echo "4. Re-run this workflow"
            echo ""
            echo "üì¶ Files ready for manual upload:"
            ls -la *.changes *.dsc *.tar.*
            exit 0
          fi
          
          echo "üì§ Uploading to PPA: $LAUNCHPAD_PPA"
          
          # ‰∏ä‰º†Âà∞ PPA
          dput "$LAUNCHPAD_PPA" *.changes
          
          echo "‚úÖ Successfully uploaded to PPA!"
          echo ""
          echo "üéâ Package will be available at:"
          echo "   https://launchpad.net/~$(echo $LAUNCHPAD_PPA | cut -d: -f2)"
          echo ""
          echo "üì• Users can install with:"
          echo "   sudo add-apt-repository $LAUNCHPAD_PPA"
          echo "   sudo apt update"
          echo "   sudo apt install novel-editor"

      - name: Upload PPA artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ppa-package
          path: |
            novel-editor-*/*.changes
            novel-editor-*/*.dsc
            novel-editor-*/*.tar.*
          retention-days: 30

      - name: Create success summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo ""
          echo "üéâ PPA Package Summary"
          echo "======================"
          echo "‚úÖ Version: $VERSION"
          echo "‚úÖ Source package built"
          echo "‚úÖ GPG signed"
          echo "‚úÖ Lintian checked"
          echo ""
          echo "üì¶ Installation commands:"
          echo "   sudo add-apt-repository ppa:username/novel-editor"
          echo "   sudo apt update"
          echo "   sudo apt install novel-editor"
          echo ""
          echo "üîó Supported distributions:"
          echo "   - Ubuntu (all supported versions)"
          echo "   - Debian (stable/testing/unstable)"
          echo "   - Linux Mint"
          echo "   - Pop!_OS"
          echo "   - Elementary OS"