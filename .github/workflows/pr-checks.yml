name: PR Checks

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  pr-metadata:
    name: PR Metadata Check
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Check PR title format
        uses: actions/github-script@v8
        with:
          script: |
            const title = context.payload.pull_request.title;
            const validPrefixes = ['feat:', 'fix:', 'docs:', 'style:', 'refactor:', 'perf:', 'test:', 'chore:', 'ci:'];
            const hasValidPrefix = validPrefixes.some(prefix => title.toLowerCase().startsWith(prefix));
            
            if (!hasValidPrefix) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âš ï¸ PR æ ‡é¢˜å»ºè®®ä½¿ç”¨è§„èŒƒæ ¼å¼ï¼š\n\n${validPrefixes.map(p => `- \`${p}\``).join('\n')}\n\nä¾‹å¦‚ï¼š\`feat: æ·»åŠ æ–°åŠŸèƒ½\` æˆ– \`fix: ä¿®å¤ bug\``
              });
            }
      
      - name: Label by changed files
        uses: actions/labeler@v6
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
      
      - name: Check PR size
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;
            
            let sizeLabel = '';
            if (total < 100) sizeLabel = 'size/XS';
            else if (total < 300) sizeLabel = 'size/S';
            else if (total < 1000) sizeLabel = 'size/M';
            else if (total < 3000) sizeLabel = 'size/L';
            else sizeLabel = 'size/XL';
            
            // ç§»é™¤æ—§çš„ size æ ‡ç­¾
            const labels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            for (const label of labels.data) {
              if (label.name.startsWith('size/')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label.name
                });
              }
            }
            
            // æ·»åŠ æ–°çš„ size æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [sizeLabel]
            });
            
            // å¦‚æœ PR å¤ªå¤§ï¼Œæ·»åŠ è¯„è®º
            if (total > 1000) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âš ï¸ è¿™ä¸ª PR æ”¹åŠ¨è¾ƒå¤§ï¼ˆ${total} è¡Œï¼‰ã€‚å»ºè®®è€ƒè™‘æ‹†åˆ†æˆå¤šä¸ªå° PRï¼Œä¾¿äº reviewã€‚`
              });
            }
      
      - name: Check for breaking changes
        uses: actions/github-script@v8
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const title = context.payload.pull_request.title || '';
            
            if (body.includes('BREAKING CHANGE') || title.includes('!')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['breaking-change']
              });
            }

  pr-comment-stats:
    name: PR Statistics
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Generate PR stats
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // è·å–æ–‡ä»¶å˜æ›´ç»Ÿè®¡
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const filesByType = {};
            files.data.forEach(file => {
              const ext = file.filename.split('.').pop();
              filesByType[ext] = (filesByType[ext] || 0) + 1;
            });
            
            const statsComment = `
            ## ğŸ“Š PR ç»Ÿè®¡ä¿¡æ¯
            
            - **æ–‡ä»¶å˜æ›´**: ${files.data.length} ä¸ªæ–‡ä»¶
            - **ä»£ç å¢åŠ **: +${pr.additions} è¡Œ
            - **ä»£ç åˆ é™¤**: -${pr.deletions} è¡Œ
            - **æ€»å˜æ›´**: ${pr.additions + pr.deletions} è¡Œ
            
            ### æ–‡ä»¶ç±»å‹åˆ†å¸ƒ
            ${Object.entries(filesByType).map(([ext, count]) => `- \`.${ext}\`: ${count} ä¸ªæ–‡ä»¶`).join('\n')}
            `;
            
            // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰ç»Ÿè®¡è¯„è®º
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ğŸ“Š PR ç»Ÿè®¡ä¿¡æ¯')
            );
            
            if (botComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: statsComment
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: statsComment
              });
            }
