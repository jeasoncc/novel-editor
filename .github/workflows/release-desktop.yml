name: Release Desktop App

on:
  workflow_dispatch:
  push:
    tags:
      - "desktop-v*.*.*"   # ä»…åœ¨æ‰“ tag æ—¶è§¦å‘ (desktop-v0.1.7)

# é¿å…é‡å¤æ„å»ºï¼ˆç‰¹åˆ«æ˜¯å¤šä¸ª tag åŒæ—¶æ¨é€æ—¶ï¼‰
concurrency:
  group: release-desktop-${{ github.ref }}
  cancel-in-progress: false  # å‘å¸ƒæµç¨‹ä¸å–æ¶ˆï¼Œç¡®ä¿å®Œæ•´æ€§

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'ubuntu-22.04-arm'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v6

      # Ubuntu ç³»ç»Ÿä¾èµ–
      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04' || matrix.platform == 'ubuntu-22.04-arm'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            build-essential \
            pkg-config \
            xdg-utils

      # å®‰è£… Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # å®‰è£… Rust
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'apps/desktop/src-tauri -> target'

      # å®‰è£…æ ¹ç›®å½•ä¾èµ–ï¼ˆmonorepoï¼‰
      - name: Install root dependencies
        run: bun install

      # å®‰è£…æ¡Œé¢åº”ç”¨ä¾èµ–
      - name: Install desktop dependencies
        working-directory: apps/desktop
        run: bun install

      # æ„å»ºæ¡Œé¢åº”ç”¨å‰ç«¯
      - name: Build frontend
        working-directory: apps/desktop
        run: bun run build
      
      # éªŒè¯å‰ç«¯æ„å»º (è·¨å¹³å°)
      - name: Verify frontend build (Unix)
        if: runner.os != 'Windows'
        working-directory: apps/desktop
        run: |
          if [ ! -d "dist" ]; then
            echo "Frontend build failed: dist directory not found"
            exit 1
          fi
          echo "Frontend build successful"
          ls -la dist/
      
      - name: Verify frontend build (Windows)
        if: runner.os == 'Windows'
        working-directory: apps/desktop
        shell: pwsh
        run: |
          if (-not (Test-Path "dist")) {
            Write-Error "Frontend build failed: dist directory not found"
            exit 1
          }
          Write-Output "Frontend build successful"
          Get-ChildItem dist/

      # é¢„ä¸‹è½½ WiX å·¥å…·åŒ… (Windows only) - é¿å… 503 é”™è¯¯
      - name: Cache WiX Toolset
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        id: wix-cache
        with:
          path: ~/.tauri/WixTools
          key: wix-tools-3.14.1
          restore-keys: |
            wix-tools-

      - name: Download WiX Toolset
        if: runner.os == 'Windows' && steps.wix-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $wixDir = "$env:USERPROFILE\.tauri\WixTools"
          New-Item -ItemType Directory -Force -Path $wixDir | Out-Null
          
          $maxRetries = 3
          $retryCount = 0
          $success = $false
          
          while (-not $success -and $retryCount -lt $maxRetries) {
            try {
              Write-Output "Downloading WiX Toolset (attempt $($retryCount + 1)/$maxRetries)..."
              Invoke-WebRequest -Uri "https://github.com/wixtoolset/wix3/releases/download/wix3141rtm/wix314-binaries.zip" -OutFile "$wixDir\wix314-binaries.zip" -UseBasicParsing
              
              Write-Output "Extracting WiX Toolset..."
              Expand-Archive -Path "$wixDir\wix314-binaries.zip" -DestinationPath $wixDir -Force
              Remove-Item "$wixDir\wix314-binaries.zip"
              
              $success = $true
              Write-Output "WiX Toolset downloaded and extracted successfully"
            } catch {
              $retryCount++
              if ($retryCount -lt $maxRetries) {
                Write-Warning "Download failed, retrying in 10 seconds..."
                Start-Sleep -Seconds 10
              } else {
                Write-Error "Failed to download WiX Toolset after $maxRetries attempts"
                throw
              }
            }
          }

      # æ„å»º Tauri Appï¼ˆä¸ä¸Šä¼ åˆ° releaseï¼‰
      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: apps/desktop
          args: ${{ matrix.args }}

      # ä¸Šä¼ åˆ° GitHub Release (Linux)
      - name: Upload to Release (Linux)
        if: success() && runner.os == 'Linux' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            apps/desktop/src-tauri/target/release/bundle/deb/*.deb
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            apps/desktop/src-tauri/target/release/bundle/rpm/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼ åˆ° GitHub Release (macOS)
      - name: Upload to Release (macOS)
        if: success() && runner.os == 'macOS' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            apps/desktop/src-tauri/target/*/release/bundle/dmg/*.dmg
            apps/desktop/src-tauri/target/*/release/bundle/macos/*.app.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼ åˆ° GitHub Release (Windows)
      - name: Upload to Release (Windows)
        if: success() && runner.os == 'Windows' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            apps/desktop/src-tauri/target/release/bundle/msi/*.msi
            apps/desktop/src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Artifacts (Linux)
      - name: Upload build artifacts (Linux)
        if: success() && runner.os == 'Linux'
        uses: actions/upload-artifact@v5
        with:
          name: tauri-bundles-${{ matrix.platform }}
          path: |
            apps/desktop/src-tauri/target/release/bundle/deb/*.deb
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            apps/desktop/src-tauri/target/release/bundle/rpm/*.rpm
      
      # ä¸Šä¼ æ„å»ºäº§ç‰© (macOS)
      - name: Upload build artifacts (macOS)
        if: success() && runner.os == 'macOS'
        uses: actions/upload-artifact@v5
        with:
          name: tauri-bundles-${{ matrix.platform }}-${{ matrix.args }}
          path: |
            apps/desktop/src-tauri/target/*/release/bundle/dmg/*.dmg
            apps/desktop/src-tauri/target/*/release/bundle/macos/*.app
      
      # ä¸Šä¼ æ„å»ºäº§ç‰© (Windows)
      - name: Upload build artifacts (Windows)
        if: success() && runner.os == 'Windows'
        uses: actions/upload-artifact@v5
        with:
          name: tauri-bundles-windows
          path: |
            apps/desktop/src-tauri/target/release/bundle/msi/*.msi
            apps/desktop/src-tauri/target/release/bundle/nsis/*.exe

  # æ„å»º MSIX åŒ…ï¼ˆä»… Windowsï¼‰
  build-msix:
    runs-on: windows-latest
    permissions:
      contents: write
    # åªåœ¨æ‰“ tag æ—¶è¿è¡Œ
    if: startsWith(github.ref, 'refs/tags/desktop-v')
    
    steps:
      - uses: actions/checkout@v6

      # å®‰è£… Rust
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'apps/desktop/src-tauri -> target'

      # å®‰è£… Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          bun install
          cd apps/desktop
          bun install

      # é¢„ä¸‹è½½ WiX å·¥å…·åŒ… - é¿å… 503 é”™è¯¯
      - name: Cache WiX Toolset
        uses: actions/cache@v4
        id: wix-cache
        with:
          path: ~/.tauri/WixTools
          key: wix-tools-3.14.1
          restore-keys: |
            wix-tools-

      - name: Download WiX Toolset
        if: steps.wix-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $wixDir = "$env:USERPROFILE\.tauri\WixTools"
          New-Item -ItemType Directory -Force -Path $wixDir | Out-Null
          
          $maxRetries = 3
          $retryCount = 0
          $success = $false
          
          while (-not $success -and $retryCount -lt $maxRetries) {
            try {
              Write-Output "Downloading WiX Toolset (attempt $($retryCount + 1)/$maxRetries)..."
              Invoke-WebRequest -Uri "https://github.com/wixtoolset/wix3/releases/download/wix3141rtm/wix314-binaries.zip" -OutFile "$wixDir\wix314-binaries.zip" -UseBasicParsing
              
              Write-Output "Extracting WiX Toolset..."
              Expand-Archive -Path "$wixDir\wix314-binaries.zip" -DestinationPath $wixDir -Force
              Remove-Item "$wixDir\wix314-binaries.zip"
              
              $success = $true
              Write-Output "WiX Toolset downloaded and extracted successfully"
            } catch {
              $retryCount++
              if ($retryCount -lt $maxRetries) {
                Write-Warning "Download failed, retrying in 10 seconds..."
                Start-Sleep -Seconds 10
              } else {
                Write-Error "Failed to download WiX Toolset after $maxRetries attempts"
                throw
              }
            }
          }

      # æ„å»º Tauri åº”ç”¨
      - name: Build Tauri app
        working-directory: apps/desktop
        run: bun run tauri build

      # åˆ›å»º MSIX åŒ…
      - name: Create MSIX package
        shell: pwsh
        env:
          MSIX_IDENTITY_NAME: ${{ secrets.MSIX_IDENTITY_NAME }}
          MSIX_PUBLISHER: ${{ secrets.MSIX_PUBLISHER }}
          MSIX_PUBLISHER_DISPLAY_NAME: ${{ secrets.MSIX_PUBLISHER_DISPLAY_NAME }}
        run: |
          Write-Output "åˆ›å»º MSIX åŒ…..."
          
          # è¯»å–ç‰ˆæœ¬å·
          $config = Get-Content 'apps/desktop/src-tauri/tauri.conf.json' | ConvertFrom-Json
          $version = $config.version
          
          # è·å– Identity ä¿¡æ¯ï¼ˆä»ç¯å¢ƒå˜é‡æˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰
          $identityName = $env:MSIX_IDENTITY_NAME
          $publisher = $env:MSIX_PUBLISHER
          $publisherDisplayName = $env:MSIX_PUBLISHER_DISPLAY_NAME
          
          # ä½¿ç”¨é»˜è®¤å€¼ï¼ˆå¦‚æœæœªè®¾ç½® secretsï¼‰- ä½¿ç”¨ Microsoft Store Partner Center çš„å€¼
          if ([string]::IsNullOrEmpty($identityName)) {
            $identityName = "Jeason.5842835EA9EE6"
            Write-Warning "âš  ä½¿ç”¨é»˜è®¤ Identity Name: $identityName"
          }
          if ([string]::IsNullOrEmpty($publisher)) {
            $publisher = "CN=056C6E40-362E-4DC2-A03D-B19B795AA254"
            Write-Warning "âš  ä½¿ç”¨é»˜è®¤ Publisher: $publisher"
          }
          if ([string]::IsNullOrEmpty($publisherDisplayName)) {
            $publisherDisplayName = "Jeason"
          }
          
          Write-Output ""
          Write-Output "ğŸ“ Package Identity:"
          Write-Output "   Name: $identityName"
          Write-Output "   Publisher: $publisher"
          Write-Output "   Publisher Display Name: $publisherDisplayName"
          Write-Output "   Version: $version.0"
          Write-Output ""
          
          # æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶
          $exePath = "apps/desktop/src-tauri/target/release/novel-editor.exe"
          if (-not (Test-Path $exePath)) {
            Write-Error "æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $exePath"
            exit 1
          }
          
          Write-Output "âœ“ æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $exePath"
          
          # åˆ›å»º MSIX ç›®å½•ç»“æ„
          $msixDir = "msix-package"
          New-Item -ItemType Directory -Force -Path $msixDir | Out-Null
          New-Item -ItemType Directory -Force -Path "$msixDir/Assets" | Out-Null
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          Copy-Item $exePath "$msixDir/novel-editor.exe"
          Write-Output "âœ“ å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶"
          
          # å¤åˆ¶å›¾æ ‡
          Copy-Item "apps/desktop/src-tauri/icons/Square44x44Logo.png" "$msixDir/Assets/"
          Copy-Item "apps/desktop/src-tauri/icons/Square150x150Logo.png" "$msixDir/Assets/"
          Copy-Item "apps/desktop/src-tauri/icons/StoreLogo.png" "$msixDir/Assets/"
          Write-Output "âœ“ å¤åˆ¶å›¾æ ‡æ–‡ä»¶"
          
          # åˆ›å»º AppxManifest.xml
          $manifest = @"
          <?xml version="1.0" encoding="utf-8"?>
          <Package xmlns="http://schemas.microsoft.com/appx/manifest/foundation/windows10"
                   xmlns:uap="http://schemas.microsoft.com/appx/manifest/uap/windows10"
                   xmlns:rescap="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities">
            <Identity Name="$identityName"
                      Publisher="$publisher"
                      Version="$version.0" />
            <Properties>
              <DisplayName>å°éº¦å†™ä½œ</DisplayName>
              <PublisherDisplayName>$publisherDisplayName</PublisherDisplayName>
              <Logo>Assets\StoreLogo.png</Logo>
            </Properties>
            <Dependencies>
              <TargetDeviceFamily Name="Windows.Desktop" MinVersion="10.0.17763.0" MaxVersionTested="10.0.22621.0" />
            </Dependencies>
            <Resources>
              <Resource Language="zh-CN" />
            </Resources>
            <Applications>
              <Application Id="NovelEditor" Executable="novel-editor.exe" EntryPoint="Windows.FullTrustApplication">
                <uap:VisualElements DisplayName="å°éº¦å†™ä½œ"
                                    Description="ä¸€ä¸ªç°ä»£åŒ–çš„å°è¯´ç¼–è¾‘å™¨"
                                    BackgroundColor="transparent"
                                    Square150x150Logo="Assets\Square150x150Logo.png"
                                    Square44x44Logo="Assets\Square44x44Logo.png">
                </uap:VisualElements>
              </Application>
            </Applications>
            <Capabilities>
              <rescap:Capability Name="runFullTrust" />
            </Capabilities>
          </Package>
          "@
          
          Set-Content -Path "$msixDir/AppxManifest.xml" -Value $manifest -Encoding UTF8
          Write-Output "âœ“ åˆ›å»º AppxManifest.xml"
          
          # æŸ¥æ‰¾ MakeAppx
          Write-Output "æŸ¥æ‰¾ MakeAppx å·¥å…·..."
          $makeAppx = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter "makeappx.exe" -ErrorAction SilentlyContinue | 
                      Where-Object { $_.FullName -like "*\x64\*" } | 
                      Select-Object -First 1 -ExpandProperty FullName
          
          if (-not $makeAppx) {
            Write-Error "æœªæ‰¾åˆ° MakeAppx å·¥å…·"
            exit 1
          }
          
          Write-Output "âœ“ æ‰¾åˆ° MakeAppx: $makeAppx"
          
          # æ‰“åŒ… MSIX
          $outputMsix = "novel-editor_${version}_x64.msix"
          Write-Output "æ‰“åŒ… MSIX: $outputMsix"
          & $makeAppx pack /d $msixDir /p $outputMsix /o
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "MSIX æ‰“åŒ…å¤±è´¥"
            exit 1
          }
          
          Write-Output "âœ“ MSIX æ‰“åŒ…æˆåŠŸ"
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          if (Test-Path $outputMsix) {
            $fileInfo = Get-Item $outputMsix
            Write-Output "æ–‡ä»¶å¤§å°: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
          } else {
            Write-Error "MSIX æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          }

      # ç­¾å MSIX
      - name: Sign MSIX
        shell: pwsh
        env:
          MSIX_PUBLISHER: ${{ secrets.MSIX_PUBLISHER }}
        run: |
          Write-Output "ç­¾å MSIX åŒ…..."
          
          # è¯»å–ç‰ˆæœ¬å·
          $config = Get-Content 'apps/desktop/src-tauri/tauri.conf.json' | ConvertFrom-Json
          $version = $config.version
          $msixFile = "novel-editor_${version}_x64.msix"
          
          if (-not (Test-Path $msixFile)) {
            Write-Error "æœªæ‰¾åˆ° MSIX æ–‡ä»¶: $msixFile"
            exit 1
          }
          
          # è·å– Publisherï¼ˆç”¨äºåˆ›å»ºè¯ä¹¦ï¼‰- å¿…é¡»ä¸ AppxManifest.xml ä¸­çš„ Publisher å®Œå…¨ä¸€è‡´
          $publisher = $env:MSIX_PUBLISHER
          if ([string]::IsNullOrEmpty($publisher)) {
            # ä½¿ç”¨ Microsoft Store Partner Center åˆ†é…çš„ Publisher ID
            $publisher = "CN=056C6E40-362E-4DC2-A03D-B19B795AA254"
            Write-Warning "âš  ä½¿ç”¨é»˜è®¤ Publisher: $publisher"
          }
          
          # åˆ›å»ºè‡ªç­¾åè¯ä¹¦ï¼ˆSubject å¿…é¡»ä¸ AppxManifest.xml ä¸­çš„ Publisher å®Œå…¨åŒ¹é…ï¼‰
          Write-Output "åˆ›å»ºè‡ªç­¾åè¯ä¹¦..."
          Write-Output "  Subject: $publisher"
          $cert = New-SelfSignedCertificate -Type Custom -Subject $publisher `
            -KeyUsage DigitalSignature -FriendlyName "Novel Editor" `
            -CertStoreLocation "Cert:\CurrentUser\My" `
            -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
          
          $password = ConvertTo-SecureString -String "temp123" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath "temp-cert.pfx" -Password $password | Out-Null
          Write-Output "âœ“ è¯ä¹¦åˆ›å»ºæˆåŠŸ"
          
          # æŸ¥æ‰¾ SignTool
          Write-Output "æŸ¥æ‰¾ SignTool..."
          $signTool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue | 
                      Where-Object { $_.FullName -like "*\x64\*" } | 
                      Select-Object -First 1 -ExpandProperty FullName
          
          if (-not $signTool) {
            Write-Error "æœªæ‰¾åˆ° SignTool"
            exit 1
          }
          
          Write-Output "æ‰¾åˆ° SignTool: $signTool"
          
          # ç­¾å MSIX
          Write-Output "æ­£åœ¨ç­¾å: $msixFile"
          & $signTool sign /fd SHA256 /a /f "temp-cert.pfx" /p "temp123" $msixFile
          
          if ($LASTEXITCODE -eq 0) {
            Write-Output "âœ“ ç­¾åæˆåŠŸ"
          } else {
            Write-Error "âœ— ç­¾åå¤±è´¥"
            exit 1
          }

      # éªŒè¯ MSIX æ–‡ä»¶
      - name: Verify MSIX package
        shell: pwsh
        run: |
          Write-Output "éªŒè¯ MSIX åŒ…..."
          
          # è¯»å–ç‰ˆæœ¬å·
          $config = Get-Content 'apps/desktop/src-tauri/tauri.conf.json' | ConvertFrom-Json
          $version = $config.version
          $msixFile = "novel-editor_${version}_x64.msix"
          
          if (Test-Path $msixFile) {
            $fileInfo = Get-Item $msixFile
            Write-Output "âœ“ MSIX æ–‡ä»¶å­˜åœ¨"
            Write-Output "  æ–‡ä»¶å: $($fileInfo.Name)"
            Write-Output "  æ–‡ä»¶å¤§å°: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
            Write-Output "  å®Œæ•´è·¯å¾„: $($fileInfo.FullName)"
          } else {
            Write-Error "MSIX æ–‡ä»¶ä¸å­˜åœ¨: $msixFile"
            exit 1
          }

      # ä¸Šä¼  MSIX äº§ç‰©
      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v5
        with:
          name: msix-package
          path: "*.msix"
          if-no-files-found: error

      # å‘å¸ƒåˆ° GitHub Release
      - name: Upload MSIX to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: "*.msix"
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
