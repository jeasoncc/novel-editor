name: Release Desktop App

on:
  workflow_dispatch:
  push:
    branches:
      - release
    tags:
      - "v*.*.*"           # 支持旧格式 (v0.1.0)
      - "desktop-v*.*.*"   # 支持新格式 (desktop-v0.1.0)

# 避免重复构建（特别是多个 tag 同时推送时）
concurrency:
  group: release-desktop-${{ github.ref }}
  cancel-in-progress: false  # 发布流程不取消，确保完整性

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            target: 'aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            target: 'x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
            target: ''
          - platform: 'ubuntu-22.04-arm'
            args: ''
            target: ''
          - platform: 'windows-latest'
            args: ''
            target: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      # Ubuntu 系统依赖
      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04' || matrix.platform == 'ubuntu-22.04-arm'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            build-essential \
            pkg-config \
            xdg-utils

      # 安装 Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # 安装 Rust
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'apps/desktop/src-tauri -> target'

      # 安装根目录依赖（monorepo）
      - name: Install root dependencies
        run: bun install

      # 安装桌面应用依赖
      - name: Install desktop dependencies
        working-directory: apps/desktop
        run: bun install

      # 构建桌面应用前端
      - name: Build frontend
        working-directory: apps/desktop
        run: bun run build
      
      # 验证前端构建 (跨平台)
      - name: Verify frontend build (Unix)
        if: runner.os != 'Windows'
        working-directory: apps/desktop
        run: |
          if [ ! -d "dist" ]; then
            echo "Frontend build failed: dist directory not found"
            exit 1
          fi
          echo "Frontend build successful"
          ls -la dist/
      
      - name: Verify frontend build (Windows)
        if: runner.os == 'Windows'
        working-directory: apps/desktop
        shell: pwsh
        run: |
          if (-not (Test-Path "dist")) {
            Write-Error "Frontend build failed: dist directory not found"
            exit 1
          }
          Write-Output "Frontend build successful"
          Get-ChildItem dist/

      # 构建 & 发布 Tauri App
      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: apps/desktop
          tagName: desktop-v__VERSION__
          releaseName: 'Novel Editor Desktop v__VERSION__'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

      # 上传构建产物 (Linux)
      - name: Upload build artifacts (Linux)
        if: success() && runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: tauri-bundles-${{ matrix.platform }}
          path: |
            apps/desktop/src-tauri/target/release/bundle/deb/*.deb
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            apps/desktop/src-tauri/target/release/bundle/rpm/*.rpm
      
      # 上传构建产物 (macOS)
      - name: Upload build artifacts (macOS)
        if: success() && runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: tauri-bundles-${{ matrix.platform }}-${{ matrix.args }}
          path: |
            apps/desktop/src-tauri/target/*/release/bundle/dmg/*.dmg
            apps/desktop/src-tauri/target/*/release/bundle/macos/*.app
      
      # 上传构建产物 (Windows)
      - name: Upload build artifacts (Windows)
        if: success() && runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: tauri-bundles-${{ matrix.platform }}
          path: |
            apps/desktop/src-tauri/target/release/bundle/msi/*.msi
            apps/desktop/src-tauri/target/release/bundle/nsis/*.exe

  # 构建 MSIX 包（仅 Windows）
  build-msix:
    needs: publish-tauri
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4

      # 安装 Rust
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'apps/desktop/src-tauri -> target'

      # 安装 Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # 安装依赖
      - name: Install dependencies
        run: |
          bun install
          cd apps/desktop
          bun install

      # 构建 Tauri 应用
      - name: Build Tauri app
        working-directory: apps/desktop
        run: bun run tauri build

      # 创建 MSIX 包
      - name: Create MSIX package
        shell: pwsh
        run: |
          Write-Output "创建 MSIX 包..."
          
          # 读取版本号
          $config = Get-Content 'apps/desktop/src-tauri/tauri.conf.json' | ConvertFrom-Json
          $version = $config.version
          
          # 查找可执行文件
          $exePath = "apps/desktop/src-tauri/target/release/novel-editor.exe"
          if (-not (Test-Path $exePath)) {
            Write-Error "未找到可执行文件: $exePath"
            exit 1
          }
          
          Write-Output "✓ 找到可执行文件: $exePath"
          
          # 创建 MSIX 目录结构
          $msixDir = "msix-package"
          New-Item -ItemType Directory -Force -Path $msixDir | Out-Null
          New-Item -ItemType Directory -Force -Path "$msixDir/Assets" | Out-Null
          
          # 复制可执行文件
          Copy-Item $exePath "$msixDir/novel-editor.exe"
          Write-Output "✓ 复制可执行文件"
          
          # 复制图标
          Copy-Item "apps/desktop/src-tauri/icons/Square44x44Logo.png" "$msixDir/Assets/"
          Copy-Item "apps/desktop/src-tauri/icons/Square150x150Logo.png" "$msixDir/Assets/"
          Copy-Item "apps/desktop/src-tauri/icons/StoreLogo.png" "$msixDir/Assets/"
          Write-Output "✓ 复制图标文件"
          
          # 创建 AppxManifest.xml
          $manifest = @"
          <?xml version="1.0" encoding="utf-8"?>
          <Package xmlns="http://schemas.microsoft.com/appx/manifest/foundation/windows10"
                   xmlns:uap="http://schemas.microsoft.com/appx/manifest/uap/windows10"
                   xmlns:rescap="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities">
            <Identity Name="Lotus.NovelEditor"
                      Publisher="CN=Lotus"
                      Version="$version.0" />
            <Properties>
              <DisplayName>Novel Editor</DisplayName>
              <PublisherDisplayName>Lotus</PublisherDisplayName>
              <Logo>Assets\StoreLogo.png</Logo>
            </Properties>
            <Dependencies>
              <TargetDeviceFamily Name="Windows.Desktop" MinVersion="10.0.17763.0" MaxVersionTested="10.0.22621.0" />
            </Dependencies>
            <Resources>
              <Resource Language="zh-CN" />
            </Resources>
            <Applications>
              <Application Id="NovelEditor" Executable="novel-editor.exe" EntryPoint="Windows.FullTrustApplication">
                <uap:VisualElements DisplayName="Novel Editor"
                                    Description="一个现代化的小说编辑器"
                                    BackgroundColor="transparent"
                                    Square150x150Logo="Assets\Square150x150Logo.png"
                                    Square44x44Logo="Assets\Square44x44Logo.png">
                </uap:VisualElements>
              </Application>
            </Applications>
            <Capabilities>
              <rescap:Capability Name="runFullTrust" />
            </Capabilities>
          </Package>
          "@
          
          Set-Content -Path "$msixDir/AppxManifest.xml" -Value $manifest -Encoding UTF8
          Write-Output "✓ 创建 AppxManifest.xml"
          
          # 查找 MakeAppx
          Write-Output "查找 MakeAppx 工具..."
          $makeAppx = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter "makeappx.exe" -ErrorAction SilentlyContinue | 
                      Where-Object { $_.FullName -like "*\x64\*" } | 
                      Select-Object -First 1 -ExpandProperty FullName
          
          if (-not $makeAppx) {
            Write-Error "未找到 MakeAppx 工具"
            exit 1
          }
          
          Write-Output "✓ 找到 MakeAppx: $makeAppx"
          
          # 打包 MSIX
          $outputMsix = "novel-editor_${version}_x64.msix"
          Write-Output "打包 MSIX: $outputMsix"
          & $makeAppx pack /d $msixDir /p $outputMsix /o
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "MSIX 打包失败"
            exit 1
          }
          
          Write-Output "✓ MSIX 打包成功"
          
          # 显示文件信息
          if (Test-Path $outputMsix) {
            $fileInfo = Get-Item $outputMsix
            Write-Output "文件大小: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
          } else {
            Write-Error "MSIX 文件未生成"
            exit 1
          }

      # 签名 MSIX
      - name: Sign MSIX
        shell: pwsh
        run: |
          Write-Output "签名 MSIX 包..."
          
          # 读取版本号
          $config = Get-Content 'apps/desktop/src-tauri/tauri.conf.json' | ConvertFrom-Json
          $version = $config.version
          $msixFile = "novel-editor_${version}_x64.msix"
          
          if (-not (Test-Path $msixFile)) {
            Write-Error "未找到 MSIX 文件: $msixFile"
            exit 1
          }
          
          # 创建自签名证书
          Write-Output "创建自签名证书..."
          $cert = New-SelfSignedCertificate -Type Custom -Subject "CN=Lotus" `
            -KeyUsage DigitalSignature -FriendlyName "Novel Editor" `
            -CertStoreLocation "Cert:\CurrentUser\My" `
            -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
          
          $password = ConvertTo-SecureString -String "temp123" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath "temp-cert.pfx" -Password $password | Out-Null
          Write-Output "✓ 证书创建成功"
          
          # 查找 SignTool
          Write-Output "查找 SignTool..."
          $signTool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue | 
                      Where-Object { $_.FullName -like "*\x64\*" } | 
                      Select-Object -First 1 -ExpandProperty FullName
          
          if (-not $signTool) {
            Write-Error "未找到 SignTool"
            exit 1
          }
          
          Write-Output "找到 SignTool: $signTool"
          
          # 签名 MSIX
          Write-Output "正在签名: $msixFile"
          & $signTool sign /fd SHA256 /a /f "temp-cert.pfx" /p "temp123" $msixFile
          
          if ($LASTEXITCODE -eq 0) {
            Write-Output "✓ 签名成功"
          } else {
            Write-Error "✗ 签名失败"
            exit 1
          }

      # 验证 MSIX 文件
      - name: Verify MSIX package
        shell: pwsh
        run: |
          Write-Output "验证 MSIX 包..."
          
          # 读取版本号
          $config = Get-Content 'apps/desktop/src-tauri/tauri.conf.json' | ConvertFrom-Json
          $version = $config.version
          $msixFile = "novel-editor_${version}_x64.msix"
          
          if (Test-Path $msixFile) {
            $fileInfo = Get-Item $msixFile
            Write-Output "✓ MSIX 文件存在"
            Write-Output "  文件名: $($fileInfo.Name)"
            Write-Output "  文件大小: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
            Write-Output "  完整路径: $($fileInfo.FullName)"
          } else {
            Write-Error "MSIX 文件不存在: $msixFile"
            exit 1
          }

      # 上传 MSIX 产物
      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: msix-package
          path: "*.msix"
          if-no-files-found: error

      # 发布到 GitHub Release
      - name: Upload MSIX to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: "*.msix"
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
