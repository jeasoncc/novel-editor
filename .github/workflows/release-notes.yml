name: Generate Release Notes

on:
  release:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name for release notes'
        required: true
        type: string

jobs:
  generate-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate release notes
        id: notes
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          PREV_TAG=$(git describe --tags --abbrev=0 $TAG^ 2>/dev/null || echo "")
          
          echo "# ðŸŽ‰ Release $TAG" > release-notes.md
          echo "" >> release-notes.md
          
          # èŽ·å–æäº¤åŽ†å²
          if [ -n "$PREV_TAG" ]; then
            echo "## ðŸ“ æ›´æ–°å†…å®¹" >> release-notes.md
            echo "" >> release-notes.md
            
            # æŒ‰ç±»åž‹åˆ†ç»„æäº¤
            echo "### âœ¨ æ–°åŠŸèƒ½" >> release-notes.md
            git log $PREV_TAG..$TAG --pretty=format:"- %s (%h)" --grep="^feat" >> release-notes.md || echo "æ— " >> release-notes.md
            echo "" >> release-notes.md
            echo "" >> release-notes.md
            
            echo "### ðŸ› Bug ä¿®å¤" >> release-notes.md
            git log $PREV_TAG..$TAG --pretty=format:"- %s (%h)" --grep="^fix" >> release-notes.md || echo "æ— " >> release-notes.md
            echo "" >> release-notes.md
            echo "" >> release-notes.md
            
            echo "### ðŸ“š æ–‡æ¡£" >> release-notes.md
            git log $PREV_TAG..$TAG --pretty=format:"- %s (%h)" --grep="^docs" >> release-notes.md || echo "æ— " >> release-notes.md
            echo "" >> release-notes.md
            echo "" >> release-notes.md
            
            echo "### ðŸŽ¨ æ ·å¼æ”¹è¿›" >> release-notes.md
            git log $PREV_TAG..$TAG --pretty=format:"- %s (%h)" --grep="^style" >> release-notes.md || echo "æ— " >> release-notes.md
            echo "" >> release-notes.md
            echo "" >> release-notes.md
            
            echo "### â™»ï¸ é‡æž„" >> release-notes.md
            git log $PREV_TAG..$TAG --pretty=format:"- %s (%h)" --grep="^refactor" >> release-notes.md || echo "æ— " >> release-notes.md
            echo "" >> release-notes.md
            echo "" >> release-notes.md
            
            echo "### âš¡ æ€§èƒ½ä¼˜åŒ–" >> release-notes.md
            git log $PREV_TAG..$TAG --pretty=format:"- %s (%h)" --grep="^perf" >> release-notes.md || echo "æ— " >> release-notes.md
            echo "" >> release-notes.md
            echo "" >> release-notes.md
            
            # ç»Ÿè®¡ä¿¡æ¯
            COMMIT_COUNT=$(git rev-list --count $PREV_TAG..$TAG)
            CONTRIBUTORS=$(git log $PREV_TAG..$TAG --format='%an' | sort -u | wc -l)
            FILES_CHANGED=$(git diff --shortstat $PREV_TAG..$TAG | awk '{print $1}')
            
            echo "## ðŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> release-notes.md
            echo "" >> release-notes.md
            echo "- æäº¤æ•°: $COMMIT_COUNT" >> release-notes.md
            echo "- è´¡çŒ®è€…: $CONTRIBUTORS" >> release-notes.md
            echo "- æ–‡ä»¶å˜æ›´: $FILES_CHANGED" >> release-notes.md
          else
            echo "é¦–æ¬¡å‘å¸ƒ ðŸŽŠ" >> release-notes.md
          fi
          
          echo "" >> release-notes.md
          echo "## ðŸ“¦ å®‰è£…æ–¹å¼" >> release-notes.md
          echo "" >> release-notes.md
          
          if [[ "$TAG" == desktop-v* ]]; then
            echo "### Desktop åº”ç”¨" >> release-notes.md
            echo "" >> release-notes.md
            echo "#### Arch Linux (AUR)" >> release-notes.md
            echo "\`\`\`bash" >> release-notes.md
            echo "yay -S novel-editor" >> release-notes.md
            echo "# æˆ–" >> release-notes.md
            echo "paru -S novel-editor" >> release-notes.md
            echo "\`\`\`" >> release-notes.md
            echo "" >> release-notes.md
            echo "#### å…¶ä»– Linux å‘è¡Œç‰ˆ" >> release-notes.md
            echo "ä¸‹è½½å¯¹åº”çš„ .deb æˆ– .rpm åŒ…è¿›è¡Œå®‰è£…" >> release-notes.md
            echo "" >> release-notes.md
            echo "#### Windows" >> release-notes.md
            echo "ä¸‹è½½ .msi æˆ– .exe å®‰è£…åŒ…" >> release-notes.md
            echo "" >> release-notes.md
            echo "#### macOS" >> release-notes.md
            echo "ä¸‹è½½ .dmg æ–‡ä»¶" >> release-notes.md
          fi
          
          echo "" >> release-notes.md
          echo "---" >> release-notes.md
          echo "" >> release-notes.md
          echo "**å®Œæ•´å˜æ›´æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...$TAG" >> release-notes.md
      
      - name: Update release
        if: github.event_name == 'release'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const notes = fs.readFileSync('release-notes.md', 'utf8');
            
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: notes
            });
      
      - name: Upload release notes
        uses: actions/upload-artifact@v6
        with:
          name: release-notes
          path: release-notes.md
