name: Publish to Winget

# ä¾èµ– desktop æ„å»ºå®Œæˆï¼ˆéœ€è¦ MSI æ–‡ä»¶ï¼‰ï¼Œåªé€šè¿‡ workflow_dispatch è§¦å‘
# desktop å®Œæˆåä¼šè‡ªåŠ¨è§¦å‘æ­¤å·¥ä½œæµ
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.45)'
        required: true
        type: string

jobs:
  winget-publish:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set version
        id: version
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
          } elseif ("${{ github.ref }}" -like "refs/tags/winget-v*") {
            $version = "${{ github.ref }}" -replace "refs/tags/winget-v", ""
          } elseif ("${{ github.event_name }}" -eq "workflow_run") {
            # ä» package.json è¯»å–ç‰ˆæœ¬å·
            $packageJson = Get-Content "package.json" | ConvertFrom-Json
            $version = $packageJson.version
          } else {
            $version = "${{ github.event.release.tag_name }}" -replace "desktop-v", ""
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Download MSI installer
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $url = "https://github.com/${{ github.repository }}/releases/download/desktop-v$version/novel-editor_${version}_x64_zh-CN.msi"
          $output = "novel-editor_${version}_x64_zh-CN.msi"
          
          Write-Host "Downloading from: $url"
          try {
            Invoke-WebRequest -Uri $url -OutFile $output -ErrorAction Stop
            Write-Host "Downloaded successfully: $output"
            
            # éªŒè¯æ–‡ä»¶å­˜åœ¨ä¸”å¤§å°åˆç†
            $fileInfo = Get-Item $output
            Write-Host "File size: $($fileInfo.Length) bytes"
            
            if ($fileInfo.Length -lt 1MB) {
              throw "Downloaded file is too small, likely not a valid MSI"
            }
          } catch {
            Write-Error "Failed to download MSI: $_"
            exit 1
          }

      - name: Calculate SHA256
        id: sha256
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $file = "novel-editor_${version}_x64_zh-CN.msi"
          
          if (Test-Path $file) {
            $hash = (Get-FileHash -Path $file -Algorithm SHA256).Hash
            echo "SHA256=$hash" >> $env:GITHUB_OUTPUT
            Write-Host "SHA256: $hash"
          } else {
            Write-Error "MSI file not found: $file"
            exit 1
          }

      - name: Update Winget manifests
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $sha256 = "${{ steps.sha256.outputs.SHA256 }}"
          $url = "https://github.com/${{ github.repository }}/releases/download/desktop-v$version/novel-editor_${version}_x64_zh-CN.msi"
          
          # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
          $versionContent = "# yaml-language-server: `$schema=https://aka.ms/winget-manifest.version.1.5.0.schema.json`n`nPackageIdentifier: Jeason.NovelEditor`nPackageVersion: $version`nDefaultLocale: zh-CN`nManifestType: version`nManifestVersion: 1.5.0"
          
          # æ›´æ–°å®‰è£…å™¨æ–‡ä»¶
          $installerContent = "# yaml-language-server: `$schema=https://aka.ms/winget-manifest.installer.1.5.0.schema.json`n`nPackageIdentifier: Jeason.NovelEditor`nPackageVersion: $version`nPlatform:`n- Windows.Desktop`nMinimumOSVersion: 10.0.0.0`nInstallerType: wix`nScope: machine`nInstallModes:`n- interactive`n- silent`n- silentWithProgress`nUpgradeBehavior: install`nInstallers:`n- Architecture: x64`n  InstallerUrl: $url`n  InstallerSha256: $sha256`nManifestType: installer`nManifestVersion: 1.5.0"
          
          # å†™å…¥æ–‡ä»¶
          $versionContent | Out-File -FilePath "winget-manifests/Jeason.NovelEditor.yaml" -Encoding UTF8
          $installerContent | Out-File -FilePath "winget-manifests/Jeason.NovelEditor.installer.yaml" -Encoding UTF8
          
          Write-Host "Updated manifest files for version $version"

      - name: Install winget-create
        run: |
          # ä¸‹è½½å¹¶å®‰è£… winget-create
          $url = "https://github.com/microsoft/winget-create/releases/latest/download/wingetcreate.exe"
          Invoke-WebRequest -Uri $url -OutFile "wingetcreate.exe"
          Write-Host "Downloaded winget-create"

      - name: Submit to Winget Community Repository
        env:
          GITHUB_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $installerUrl = "https://github.com/${{ github.repository }}/releases/download/desktop-v$version/novel-editor_${version}_x64_zh-CN.msi"
          
          # é…ç½®git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ›å»ºä¸´æ—¶ manifest ç›®å½•
          $manifestDir = "winget-submit"
          New-Item -ItemType Directory -Force -Path $manifestDir | Out-Null
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ token
          if ([string]::IsNullOrEmpty($env:GITHUB_TOKEN)) {
            Write-Warning "âš  WINGET_GITHUB_TOKEN not set, skipping auto-submit"
            Write-Host ""
            Write-Host "=== Manual Submission Info ==="
            Write-Host "Package ID: Jeason.NovelEditor"
            Write-Host "Version: $version"
            Write-Host "Installer URL: $installerUrl"
            Write-Host "SHA256: ${{ steps.sha256.outputs.SHA256 }}"
            Write-Host ""
            Write-Host "Please manually submit to: https://github.com/microsoft/winget-pkgs"
            Write-Host "=============================="
            exit 0
          }
          
          try {
            # ä½¿ç”¨ winget-create update å‘½ä»¤ç”Ÿæˆ manifest å¹¶æäº¤ PR
            ./wingetcreate.exe update Jeason.NovelEditor -v $version -u $installerUrl -o $manifestDir -t $env:GITHUB_TOKEN -s
            Write-Host "Successfully submitted to winget-pkgs repository"
          } catch {
            Write-Warning "Failed to auto-submit to winget-pkgs: $_"
            Write-Host "Trying alternative submission method..."
            
            try {
              # å¤‡é€‰æ–¹æ¡ˆï¼šå…ˆç”Ÿæˆ manifestï¼Œå†æ‰‹åŠ¨æäº¤
              ./wingetcreate.exe update Jeason.NovelEditor -v $version -u $installerUrl -o $manifestDir
              
              # ä½¿ç”¨ submit å‘½ä»¤æäº¤å·²ç”Ÿæˆçš„ manifestï¼ˆè·¯å¾„ä½œä¸ºä½ç½®å‚æ•°ï¼‰
              ./wingetcreate.exe submit -p "Update Jeason.NovelEditor to $version" -t $env:GITHUB_TOKEN $manifestDir
              Write-Host "Successfully submitted via alternative method"
            } catch {
              Write-Warning "Alternative submission also failed: $_"
              Write-Host ""
              Write-Host "=== Manual Submission Info ==="
              Write-Host "Package ID: Jeason.NovelEditor"
              Write-Host "Version: $version"
              Write-Host "Installer URL: $installerUrl"
              Write-Host "SHA256: ${{ steps.sha256.outputs.SHA256 }}"
              Write-Host ""
              Write-Host "Please manually submit to: https://github.com/microsoft/winget-pkgs"
              Write-Host "=============================="
            }
          }

      - name: Commit updated manifests
        continue-on-error: true
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          
          git add winget-manifests/
          
          if (git diff --staged --quiet) {
            Write-Host "No changes to commit"
          } else {
            git commit -m "chore(winget): update manifests to version $version"
            try {
              git push
              Write-Host "âœ… Committed and pushed updated manifests"
            } catch {
              Write-Warning "âš  Could not push to repository (this is optional)"
              Write-Host "The winget submission to microsoft/winget-pkgs is the main goal"
            }
          }

      - name: Create summary
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          
          Write-Host ""
          Write-Host "ğŸ‰ Winget Publication Summary"
          Write-Host "================================"
          Write-Host "âœ… Version: $version"
          Write-Host "âœ… Manifests updated"
          Write-Host "âœ… SHA256 calculated: ${{ steps.sha256.outputs.SHA256 }}"
          Write-Host ""
          Write-Host "ğŸ“‹ Next Steps:"
          Write-Host "1. Check if PR was auto-created in microsoft/winget-pkgs"
          Write-Host "2. If not, manually create PR with updated manifests"
          Write-Host "3. Wait for Microsoft review and approval"
          Write-Host ""
          Write-Host "ğŸ”— Useful Links:"
          Write-Host "- Winget-pkgs repo: https://github.com/microsoft/winget-pkgs"
          Write-Host "- Your package: https://github.com/microsoft/winget-pkgs/tree/master/manifests/j/Jeason/NovelEditor"