# 路由器端口转发问题排查

## ✅ 服务器端检查结果（全部正常）

1. ✅ Nginx 正在监听 `0.0.0.0:1420`
2. ✅ 本地访问正常：`curl http://localhost:1420` 返回 200 OK
3. ✅ 内网访问正常：`curl http://192.168.5.4:1420` 返回 200 OK
4. ✅ 防火墙未启用（不是防火墙问题）

## 🔍 问题分析

从你的情况看：
- **80 端口可以访问**（显示了路由器登录页）✅
- **1420 端口无法访问** ❌
- **服务器配置完全正确** ✅

**结论：问题出在路由器端口转发配置上！**

## 🎯 路由器配置检查清单

根据你的路由器界面，请确认以下几点：

### 1. 端口转发配置是否正确提交

从截图看到你有端口转发配置：
```
名称: novel-editor的website
协议: TCP
内网IP: 192.168.5.4
外网端口: 1420
内网端口: 1420
状态: 开启 ✅
```

**⚠️ 关键步骤：**
1. 确保点击了 **"提交" (Submit)** 按钮
2. 等待配置生效（可能需要几秒钟）
3. 检查是否有"保存成功"或类似的提示

### 2. 检查路由器的其他安全设置

#### A. DMZ 设置
- 确保没有把其他设备设置为 DMZ 主机
- DMZ 可能会干扰端口转发

#### B. 防火墙设置
- 检查路由器的内置防火墙
- 确保端口转发规则没有被防火墙拦截
- 查看"安全配置"或"防火墙"设置

#### C. UPnP 设置
- 检查 UPnP 是否启用
- 有时 UPnP 可能与手动端口转发冲突

### 3. 检查是否有多个端口转发规则冲突

- 确保没有其他规则也在使用 1420 端口
- 检查是否有重复的规则

### 4. 路由器固件/重启

- 尝试重启路由器
- 检查路由器固件是否需要更新

## 🔧 解决步骤

### 步骤 1: 重新配置端口转发

1. **删除现有规则**（点击垃圾桶图标）
2. **重新添加规则**：
   ```
   名称: novel-editor-website
   协议: TCP
   内网IP: 192.168.5.4
   外网端口: 1420
   内网端口: 1420
   ```
3. **确保状态选择为"开启"**
4. **点击"提交"按钮**
5. **等待 30-60 秒让配置生效**

### 步骤 2: 检查路由器防火墙/安全设置

进入"安全配置"菜单，检查：
- 端口转发是否被防火墙拦截
- 是否有其他安全策略阻止连接

### 步骤 3: 测试端口转发

#### 在服务器上测试（验证配置正确）：
```bash
# 确认服务正常
curl -I http://localhost:1420

# 确认内网访问正常
curl -I http://192.168.5.4:1420
```

#### 从外网测试（验证端口转发）：
```bash
# 在外网机器上执行
curl -v http://61.144.183.96:1420

# 或者使用 telnet 测试端口是否开放
telnet 61.144.183.96 1420
```

### 步骤 4: 尝试其他端口

如果 1420 端口仍然不行，尝试使用其他端口（如 8080）来验证端口转发功能：

1. **修改 Nginx 配置**：
   ```bash
   sudo nano /etc/nginx/nginx.conf
   ```
   将 `listen 1420;` 改为 `listen 8080;`

2. **重启 Nginx**：
   ```bash
   sudo systemctl reload nginx
   ```

3. **在路由器中添加新的端口转发**：
   ```
   外网端口: 8080 → 内网IP: 192.168.5.4 → 内网端口: 8080
   ```

4. **测试**：`http://61.144.183.96:8080`

## 🧪 诊断测试

### 测试 1: 确认服务器端正常
```bash
# 在服务器上执行
echo "=== 测试服务器端 ==="
curl -I http://localhost:1420
curl -I http://192.168.5.4:1420
ss -tlnp | grep 1420
```

### 测试 2: 从局域网其他设备测试
```bash
# 从局域网内的其他电脑/手机执行
curl -I http://192.168.5.4:1420
```

### 测试 3: 从外网测试
```bash
# 在外网机器/手机上执行（使用移动网络，不使用 WiFi）
curl -v http://61.144.183.96:1420
```

### 测试 4: 端口扫描
```bash
# 在外网机器上执行，检查端口是否开放
nmap -p 1420 61.144.183.96
# 或者
nc -zv 61.144.183.96 1420
```

## 💡 常见问题

### Q: 为什么 80 端口可以访问，但 1420 不行？
A: 
- 80 端口可能是路由器的管理端口，默认开放
- 1420 端口需要手动配置端口转发
- 说明路由器本身是可达的，问题在端口转发配置

### Q: 配置已经提交了，为什么还是不行？
A: 
- 路由器配置可能需要重启才能生效
- 检查是否有其他安全设置阻止了连接
- 尝试删除并重新添加规则

### Q: 路由器重启后还是不行怎么办？
A: 
- 检查内网 IP 是否变化（192.168.5.4）
- 确认服务器的 IP 地址配置是静态的，不是 DHCP
- 尝试使用 DMZ（临时测试，不建议长期使用）

## 🚀 快速修复尝试

### 方法 1: 重新配置端口转发

1. 登录路由器管理界面：`http://61.144.183.96`
2. 进入"端口转发"页面
3. **删除现有的 1420 规则**（点击垃圾桶图标）
4. 点击"新建条目"
5. 填写：
   - 名称: `novel-editor-1420`
   - 协议: `TCP`
   - 内网IP: `192.168.5.4`
   - 外网端口: `1420`
   - 内网端口: `1420`
   - 状态: **开启**
6. **点击"提交"按钮**
7. 等待 1 分钟
8. 测试访问：`http://61.144.183.96:1420`

### 方法 2: 使用其他端口测试

创建一个新的端口转发规则测试：

```bash
# 1. 修改 nginx 配置，添加 8080 端口
sudo nano /etc/nginx/nginx.conf
# 在 server 块中添加：
server {
    listen 8080;
    server_name _;
    root /home/lotus/test-site;
    index index.html;
}
```

```bash
# 2. 重启 nginx
sudo systemctl reload nginx
```

```bash
# 3. 在路由器中添加端口转发：
# 外网 8080 → 内网 192.168.5.4:8080
```

```bash
# 4. 测试
curl http://61.144.183.96:8080
```

## 📝 需要你做的操作

1. **重新配置端口转发**（删除旧规则，添加新规则，确保点击提交）
2. **等待 1-2 分钟**
3. **从外网测试**（使用手机移动网络，访问 `http://61.144.183.96:1420`）
4. **如果还不行**，尝试使用 8080 端口测试

## 🔍 进一步排查

如果以上方法都不行，请提供：

1. **路由器型号和固件版本**
2. **端口转发页面的完整截图**（包括提交按钮和状态）
3. **从外网测试的结果**：
   ```bash
   # 在外网机器上执行
   curl -v http://61.144.183.96:1420
   telnet 61.144.183.96 1420
   ```
4. **路由器的"安全配置"页面截图**

这样我可以更准确地帮你定位问题！




