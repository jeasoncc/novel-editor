# Mermaid 图表错误修复说明

## 问题描述

之前在大纲图表视图中，Mermaid 的语法错误信息都堆积在界面底部，影响用户体验。

## 问题原因

1. **Mermaid 库的默认行为**：Mermaid 库会自动在页面底部生成固定定位的错误提示
2. **代码生成问题**：
   - 角色关系图中存在语法错误（将角色连接到自己）
   - 缺少对空数据的处理
   - 标题中的特殊字符（如 `"`、`[`、`]`、`:`）未转义

## 修复内容

### 1. 隐藏 Mermaid 默认错误提示

在 `src/styles.css` 中添加了样式来隐藏 Mermaid 库自动生成的错误提示：

```css
/* 隐藏 Mermaid 库自动生成的错误提示 */
[id^="d2h-"] {
  display: none !important;
}
```

### 2. 启用自定义错误处理

在 `mermaid-viewer.tsx` 中配置 Mermaid：

```typescript
mermaid.initialize({
  // ...其他配置
  suppressErrorRendering: true, // 禁用默认错误渲染
});
```

### 3. 修复代码生成器

在 `lib/mermaid-generator.ts` 中修复了所有生成函数：

#### 角色关系图
- 修复了自引用的语法错误
- 添加了空数据检查
- 转义了特殊字符

#### 章节结构图
- 添加了空数据检查
- 转义了标题中的特殊字符

#### 章节流程图
- 添加了空数据检查
- 转义了标题中的特殊字符

#### 时间线图
- 添加了空数据检查
- 转义了冒号字符（`:` → `：`）

#### 三幕结构图
- 添加了空数据检查
- 优化了章节分配逻辑
- 转义了标题中的特殊字符

#### 甘特图
- 添加了空数据检查
- 转义了冒号字符

## 效果

修复后：
- ✅ 错误信息不再堆积在底部
- ✅ 错误信息在组件内部优雅显示
- ✅ 空数据时显示友好提示
- ✅ 特殊字符不会导致语法错误
- ✅ 所有图表都能正确渲染

## 测试建议

1. 创建包含特殊字符的章节标题（如 `"第一章：开端"`）
2. 测试空数据情况（无章节、无角色）
3. 测试各种图表类型的切换
4. 验证错误提示的显示位置和样式
