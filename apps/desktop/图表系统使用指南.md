# 图表系统使用指南

## 概述

图表系统支持两种渲染引擎：
- **Mermaid**：纯前端渲染，默认启用，完全离线可用
- **PlantUML**：通过 Kroki 服务器渲染，功能更强大（可选）

## Mermaid 图表

### 特点
- ✅ 纯前端渲染，无需配置
- ✅ 完全离线可用
- ✅ 轻量级，不增加应用体积
- ✅ 支持多种图表类型

### 支持的图表
1. **结构图** - 章节和场景的层级结构
2. **流程图** - 章节的线性流程
3. **三幕结构** - 按三幕剧结构划分章节
4. **时间线** - 故事时间线展示
5. **甘特图** - 创作进度追踪
6. **角色关系图** - 角色之间的关系

## PlantUML 图表（可选）

### 特点
- ✅ 功能更强大，支持更复杂的图表
- ✅ 更丰富的样式和布局选项
- ⚠️ 需要配置 Kroki 服务器
- ⚠️ 需要网络连接

### 配置步骤

1. **打开设置**
   - 点击左侧活动栏的设置图标
   - 选择 "Diagrams" 菜单

2. **配置 Kroki 服务器**
   - 输入 Kroki 服务器地址
   - 推荐使用官方服务：`https://kroki.io`
   - 或自建 Kroki 服务器

3. **测试连接**
   - 点击"测试连接"按钮
   - 确认连接成功

4. **启用 PlantUML**
   - 打开"启用 PlantUML 支持"开关
   - 保存设置

5. **查看图表**
   - 返回大纲视图
   - 切换到"图表"标签
   - 现在可以看到额外的 PlantUML 图表选项卡

## 使用 Kroki 服务器

### 官方服务
最简单的方式是使用官方 Kroki 服务：
```
https://kroki.io
```

**优点：**
- 免费使用
- 无需安装
- 稳定可靠

**缺点：**
- 需要网络连接
- 图表数据会发送到外部服务器

### 自建服务器

如果需要完全离线或保护隐私，可以自建 Kroki 服务器。

#### 使用 Docker（推荐）

```bash
# 拉取镜像
docker pull yuzutech/kroki

# 运行服务
docker run -d -p 8000:8000 yuzutech/kroki

# 在应用中配置
# Kroki 服务器地址：http://localhost:8000
```

#### 使用 Docker Compose

创建 `docker-compose.yml`：

```yaml
version: "3"
services:
  kroki:
    image: yuzutech/kroki
    ports:
      - "8000:8000"
    environment:
      - KROKI_BLOCKDIAG_HOST=blockdiag
      - KROKI_MERMAID_HOST=mermaid
      - KROKI_BPMN_HOST=bpmn
    depends_on:
      - blockdiag
      - mermaid
      - bpmn

  blockdiag:
    image: yuzutech/kroki-blockdiag

  mermaid:
    image: yuzutech/kroki-mermaid

  bpmn:
    image: yuzutech/kroki-bpmn
```

运行：
```bash
docker-compose up -d
```

更多信息：https://docs.kroki.io/kroki/setup/install/

## 图表操作

### 复制代码
点击"复制代码"按钮，将图表的源代码复制到剪贴板。

### 下载 SVG
点击"下载 SVG"按钮，将图表保存为 SVG 文件。

### 刷新图表
如果图表显示异常，点击"刷新"按钮重新渲染。

## 常见问题

### Q: Mermaid 和 PlantUML 有什么区别？
A: 
- Mermaid 是纯前端渲染，轻量级，适合大多数场景
- PlantUML 功能更强大，支持更复杂的图表，但需要服务器支持

### Q: 必须配置 Kroki 吗？
A: 不是必须的。Mermaid 图表默认启用，无需配置。PlantUML 是可选功能。

### Q: Kroki 服务器安全吗？
A: 
- 官方服务是公开的，图表数据会发送到服务器
- 如果担心隐私，建议自建 Kroki 服务器
- Mermaid 完全在本地渲染，不涉及数据传输

### Q: 自建 Kroki 服务器会增加多少体积？
A: 
- Kroki 服务器是独立运行的，不会增加应用体积
- 应用本身只增加了约 1MB（Mermaid 库）

### Q: 图表渲染失败怎么办？
A: 
1. 检查 Kroki 服务器地址是否正确
2. 测试网络连接
3. 尝试刷新图表
4. 切换到 Mermaid 图表

## 技术细节

### Mermaid
- 版本：11.x
- 渲染方式：纯前端 SVG
- 体积：~1MB

### PlantUML
- 通过 Kroki 服务器渲染
- 支持完整的 PlantUML 语法
- 输出格式：SVG

### Kroki
- 开源项目：https://github.com/yuzutech/kroki
- 支持 20+ 种图表格式
- 可以 Docker 部署

## 更新日志

### v1.0.0
- ✅ 添加 Mermaid 图表支持
- ✅ 添加 PlantUML 图表支持（通过 Kroki）
- ✅ 图表设置页面
- ✅ 支持自定义 Kroki 服务器
- ✅ 图表导出功能
