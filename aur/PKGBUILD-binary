# Maintainer: Jeason <xiaomiquan@aliyun.com>
# 本地测试版本 - 使用已构建的二进制文件

pkgname=novel-editor
pkgver=0.1.7
pkgrel=1
pkgdesc="一款专为小说创作者设计的现代化写作工具"
arch=('x86_64')
url="https://github.com/jeasoncc/novel-editor"
license=('MIT')
depends=(
  'webkit2gtk'
  'gtk3'
  'libappindicator-gtk3'
)

# 使用本地已构建的文件
source=()
sha256sums=()
noextract=()

package() {
  # 从环境变量获取项目根目录（由测试脚本设置）
  # 如果没有设置，尝试从 startdir 推断
  local project_root="${PROJECT_ROOT:-$startdir/..}"
  local build_dir="$project_root/apps/desktop/src-tauri/target/release"
  
  if [ ! -f "$build_dir/$pkgname" ]; then
    error "找不到构建的二进制文件: $build_dir/$pkgname"
    error "请先运行: ./scripts/test-local-build.sh"
    return 1
  fi
  
  # 安装二进制文件
  install -Dm755 "$build_dir/$pkgname" \
    "$pkgdir/usr/bin/$pkgname"
  
  # 安装桌面文件
  install -Dm644 "$startdir/novel-editor.desktop" \
    "$pkgdir/usr/share/applications/$pkgname.desktop"
  
  # 安装图标
  local icon_dir="$project_root/apps/desktop/src-tauri/icons"
  for size in 32 128 256; do
    if [ -f "$icon_dir/${size}x${size}.png" ]; then
      install -Dm644 "$icon_dir/${size}x${size}.png" \
        "$pkgdir/usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png"
    fi
  done
  
  # 安装许可证
  if [ -f "$project_root/LICENSE" ]; then
    install -Dm644 "$project_root/LICENSE" \
      "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  fi
  
  # 安装文档
  if [ -f "$project_root/README.md" ]; then
    install -Dm644 "$project_root/README.md" \
      "$pkgdir/usr/share/doc/$pkgname/README.md"
  fi
}
