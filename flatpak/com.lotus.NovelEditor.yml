app-id: com.lotus.NovelEditor
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: novel-editor

finish-args:
  # Display and graphics
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  
  # Network access for updates and extensions
  - --share=network
  
  # File system access
  - --filesystem=home
  - --filesystem=xdg-documents
  - --filesystem=xdg-download
  
  # System integration
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.FileManager1
  - --talk-name=org.freedesktop.portal.Desktop
  - --talk-name=org.freedesktop.portal.Documents
  
  # Audio for notifications
  - --socket=pulseaudio
  
  # System tray support
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.freedesktop.StatusNotifierWatcher
  
  # Theme access
  - --filesystem=xdg-config/gtk-3.0:ro
  - --filesystem=xdg-config/gtk-4.0:ro
  
  # Prevent idle sleep during long writing sessions
  - --talk-name=org.freedesktop.ScreenSaver

modules:
  - name: novel-editor
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node18/bin:/usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/novel-editor/cargo
        npm_config_cache: /run/build/novel-editor/npm-cache
        BUN_INSTALL: /run/build/novel-editor/bun
        # Optimize build for release
        CARGO_PROFILE_RELEASE_LTO: 'true'
        CARGO_PROFILE_RELEASE_CODEGEN_UNITS: '1'
        CARGO_PROFILE_RELEASE_PANIC: 'abort'
    build-commands:
      # Install Bun
      - |
        echo "=== Installing Bun ==="
        curl -fsSL https://bun.sh/install | bash
        export BUN_INSTALL="$HOME/.bun"
        export PATH="$BUN_INSTALL/bin:$PATH"
        bun --version
      
      # Install root dependencies
      - |
        echo "=== Installing root dependencies ==="
        export BUN_INSTALL="$HOME/.bun"
        export PATH="$BUN_INSTALL/bin:$PATH"
        bun install --frozen-lockfile
      
      # Install desktop dependencies
      - |
        echo "=== Installing desktop dependencies ==="
        export BUN_INSTALL="$HOME/.bun"
        export PATH="$BUN_INSTALL/bin:$PATH"
        cd apps/desktop
        bun install --frozen-lockfile
      
      # Build frontend
      - |
        echo "=== Building frontend ==="
        export BUN_INSTALL="$HOME/.bun"
        export PATH="$BUN_INSTALL/bin:$PATH"
        cd apps/desktop
        bun run build
        
        # Verify build output
        if [ ! -d "dist" ]; then
          echo "ERROR: Frontend build failed - dist directory not found"
          exit 1
        fi
        echo "Frontend build successful"
      
      # Build Tauri application
      - |
        echo "=== Building Tauri application ==="
        export BUN_INSTALL="$HOME/.bun"
        export PATH="$BUN_INSTALL/bin:$PATH"
        cd apps/desktop
        bun run tauri build --bundles none
        
        # Verify binary exists
        if [ ! -f "src-tauri/target/release/novel-editor" ]; then
          echo "ERROR: Binary not found"
          exit 1
        fi
        echo "Tauri build successful"
      
      # Install binary
      - |
        echo "=== Installing binary ==="
        install -Dm755 apps/desktop/src-tauri/target/release/novel-editor /app/bin/novel-editor
        
        # Verify installation
        if [ ! -x "/app/bin/novel-editor" ]; then
          echo "ERROR: Binary installation failed"
          exit 1
        fi
        echo "Binary installed successfully"
      
      # Install desktop file
      - |
        echo "=== Installing desktop file ==="
        install -Dm644 flatpak/com.lotus.NovelEditor.desktop /app/share/applications/com.lotus.NovelEditor.desktop
        
        # Validate desktop file
        desktop-file-validate /app/share/applications/com.lotus.NovelEditor.desktop || echo "Desktop file validation warning (non-fatal)"
      
      # Install icons (multiple sizes)
      - |
        echo "=== Installing icons ==="
        # Install available icon sizes
        for size in 32 128 256; do
          if [ -f "apps/desktop/src-tauri/icons/${size}x${size}.png" ]; then
            install -Dm644 "apps/desktop/src-tauri/icons/${size}x${size}.png" \
              "/app/share/icons/hicolor/${size}x${size}/apps/com.lotus.NovelEditor.png"
            echo "Installed ${size}x${size} icon"
          fi
        done
        
        # Install scalable icon if available
        if [ -f "apps/desktop/src-tauri/icons/icon.svg" ]; then
          install -Dm644 "apps/desktop/src-tauri/icons/icon.svg" \
            "/app/share/icons/hicolor/scalable/apps/com.lotus.NovelEditor.svg"
          echo "Installed scalable icon"
        fi
      
      # Install metainfo
      - |
        echo "=== Installing metainfo ==="
        install -Dm644 flatpak/com.lotus.NovelEditor.metainfo.xml /app/share/metainfo/com.lotus.NovelEditor.metainfo.xml
        
        # Validate metainfo
        appstream-util validate-relax /app/share/metainfo/com.lotus.NovelEditor.metainfo.xml || echo "Metainfo validation warning (non-fatal)"
      
      # Install license
      - |
        echo "=== Installing license ==="
        if [ -f "LICENSE" ]; then
          install -Dm644 LICENSE /app/share/licenses/com.lotus.NovelEditor/LICENSE
        fi
      
      # Install documentation
      - |
        echo "=== Installing documentation ==="
        if [ -f "README.md" ]; then
          install -Dm644 README.md /app/share/doc/com.lotus.NovelEditor/README.md
        fi
        
        echo "=== Installation completed successfully ==="
    
    sources:
      - type: git
        url: https://github.com/jeasoncc/novel-editor.git
        tag: v0.1.44
        commit: HEAD
    
    sdk-extensions:
      - org.freedesktop.Sdk.Extension.node18
      - org.freedesktop.Sdk.Extension.rust-stable