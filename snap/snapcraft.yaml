name: grain-editor
base: core22
version: '0.1.90'
summary: Modern writing tool for long-form content and knowledge management
description: |
  Grain (Â∞èÈ∫¶) is a professional writing application designed for long-form 
  writing, knowledge management, and creative expression. Built with modern 
  web technologies and powered by the Lexical rich-text editor, it provides 
  everything you need to organize your thoughts and craft compelling content.

  üöÄ KEY FEATURES:
  
  ‚úçÔ∏è Immersive Writing Experience
  ‚Ä¢ Rich-text editing with Markdown shortcuts
  ‚Ä¢ Distraction-free writing environment
  ‚Ä¢ Real-time auto-save to prevent data loss
  ‚Ä¢ Multiple export formats (Markdown, DOCX, JSON)
  
  üìÇ Flexible Organization
  ‚Ä¢ Tree-based file management system
  ‚Ä¢ Multiple workspace support
  ‚Ä¢ Drag-and-drop file organization
  ‚Ä¢ Global search across all content
  
  üè∑Ô∏è Tag System
  ‚Ä¢ Organize content with #[tags]
  ‚Ä¢ Quick tag creation and management
  ‚Ä¢ Tag-based filtering and search
  ‚Ä¢ Visual tag relationships
  
  üë§ Wiki Links & References
  ‚Ä¢ Quick references via @ symbol
  ‚Ä¢ Hover preview for linked content
  ‚Ä¢ Bidirectional linking
  ‚Ä¢ Knowledge graph visualization
  
  üìù Daily Journal
  ‚Ä¢ Built-in diary system
  ‚Ä¢ Daily writing templates
  ‚Ä¢ Calendar view for entries
  ‚Ä¢ Writing streak tracking
  
  üìä Outline & Visualization
  ‚Ä¢ Mermaid diagram support
  ‚Ä¢ PlantUML integration
  ‚Ä¢ Visual outline management
  ‚Ä¢ Chart and graph creation
  
  üé® Customizable Interface
  ‚Ä¢ Multiple editor themes
  ‚Ä¢ Icon theme customization (6 presets)
  ‚Ä¢ Dark/light mode support
  ‚Ä¢ Responsive design
  
  üîí Privacy-First Design
  ‚Ä¢ Complete local data storage (IndexedDB)
  ‚Ä¢ No cloud dependency
  ‚Ä¢ Offline-first architecture
  ‚Ä¢ Your data stays on your device
  
  Perfect for writers, researchers, students, and anyone who needs a powerful 
  tool for organizing thoughts and creating long-form content. Whether you're 
  writing novels, research papers, documentation, or personal journals, Grain 
  provides the tools to bring your ideas to life.

  ---
  
  Note: This application was formerly known as "Novel Editor". We've rebranded 
  to "Grain" to better reflect our expanded focus on general writing and 
  knowledge management.

grade: stable
confinement: strict

architectures:
  - build-on: amd64
  - build-on: arm64

apps:
  grain:
    command: bin/grain
    extensions: [gnome]
    plugs:
      - home
      - network
      - desktop
      - desktop-legacy
      - wayland
      - x11
      - opengl
      - audio-playback
      - removable-media

parts:
  grain:
    plugin: nil
    source: .
    build-packages:
      - curl
      - wget
      - file
      - unzip
      - libwebkit2gtk-4.1-dev
      - libgtk-3-dev
      - libayatana-appindicator3-dev
      - librsvg2-dev
      - patchelf
      - build-essential
      - pkg-config
    stage-packages:
      - libwebkit2gtk-4.1-0
      - libgtk-3-0
      - libayatana-appindicator3-1
      - librsvg2-2
    override-build: |
      set -eux
      
      echo "=== Installing Bun ==="
      curl -fsSL https://bun.sh/install | bash
      export BUN_INSTALL="$HOME/.bun"
      export PATH="$BUN_INSTALL/bin:$PATH"
      bun --version
      
      echo "=== Installing Rust ==="
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
      export PATH="$HOME/.cargo/bin:$PATH"
      rustc --version
      cargo --version
      
      echo "=== Installing root dependencies ==="
      cd $CRAFT_PART_SRC
      bun install
      
      echo "=== Installing desktop dependencies ==="
      cd apps/desktop
      bun install
      
      echo "=== Building desktop frontend ==="
      bun run build
      
      # Verify build output
      if [ ! -d "dist" ]; then
        echo "ERROR: Frontend build failed - dist directory not found"
        exit 1
      fi
      
      echo "=== Building Tauri application ==="
      bun run tauri build --bundles deb
      
      echo "=== Extracting deb package ==="
      DEB_FILE=$(find src-tauri/target/release/bundle/deb -name "*.deb" | head -n 1)
      if [ -z "$DEB_FILE" ]; then
        echo "ERROR: No deb file found"
        exit 1
      fi
      
      echo "Found deb: $DEB_FILE"
      dpkg-deb -x $DEB_FILE $CRAFT_PART_INSTALL
      
      echo "=== Setting up binary ==="
      mkdir -p $CRAFT_PART_INSTALL/bin
      
      # Find and copy binary
      BINARY_PATH=$(find $CRAFT_PART_INSTALL -type f -name "grain" -executable | head -n 1)
      if [ -n "$BINARY_PATH" ]; then
        echo "Found binary at: $BINARY_PATH"
        cp "$BINARY_PATH" $CRAFT_PART_INSTALL/bin/grain
        chmod +x $CRAFT_PART_INSTALL/bin/grain
      else
        echo "ERROR: Binary not found, listing all files:"
        find $CRAFT_PART_INSTALL -type f
        exit 1
      fi
      
      echo "=== Verifying binary ==="
      ls -la $CRAFT_PART_INSTALL/bin/
      
      echo "=== Build completed successfully ==="
