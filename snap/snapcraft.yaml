name: novel-editor-app
base: core22
version: '0.1.66'
summary: Professional novel writing tool with advanced project management
description: |
  Novel Editor is a comprehensive writing application designed specifically for 
  novelists and creative writers. Built with modern web technologies and powered 
  by the Lexical rich-text editor, it provides everything you need to craft 
  compelling stories from initial concept to final manuscript.

  ğŸš€ KEY FEATURES:
  
  ğŸ“ Advanced Text Editor
  â€¢ Rich-text editing with Markdown shortcuts
  â€¢ Table support for complex formatting
  â€¢ Real-time auto-save to prevent data loss
  â€¢ Multiple export formats including DOCX
  
  ğŸ¯ Structured Project Management  
  â€¢ Three-tier hierarchy: Project â†’ Chapter â†’ Scene
  â€¢ Drag-and-drop reordering for easy organization
  â€¢ Visual outline view with quick navigation
  â€¢ Cross-project global search functionality
  
  ğŸ‘¥ Character Development
  â€¢ Comprehensive character profile system
  â€¢ Alias management for complex characters
  â€¢ Detailed backstory and experience tracking
  â€¢ Character relationship mapping
  
  ğŸŒ World-building Tools
  â€¢ Location, faction, and item organization
  â€¢ Concept management for complex universes
  â€¢ Integrated drawing canvas (Excalidraw)
  â€¢ Mermaid diagram support for plotting
  
  ğŸ“Š Writing Analytics
  â€¢ Real-time word count tracking
  â€¢ Reading time estimation
  â€¢ Chapter distribution visualization
  â€¢ Progress tracking and statistics
  
  ğŸ¨ Customizable Interface
  â€¢ Multiple editor themes (VSCode-like experience)
  â€¢ Icon theme customization
  â€¢ Responsive design for all screen sizes
  â€¢ Dark/light mode support
  
  ğŸ”’ Privacy-First Design
  â€¢ Complete local data storage (Dexie/IndexedDB)
  â€¢ No cloud dependency or data collection
  â€¢ Offline-first architecture
  â€¢ Your stories stay on your device
  
  Perfect for novelists, screenwriters, game developers, and anyone crafting 
  complex narratives. Whether you're writing your first short story or managing 
  a multi-book series, Novel Editor provides the tools to bring your creative 
  vision to life.

grade: stable
confinement: strict

architectures:
  - build-on: amd64
  - build-on: arm64

apps:
  novel-editor:
    command: bin/novel-editor
    extensions: [gnome]
    plugs:
      - home
      - network
      - desktop
      - desktop-legacy
      - wayland
      - x11
      - opengl
      - audio-playback
      - removable-media

parts:
  novel-editor:
    plugin: nil
    source: .
    build-packages:
      - curl
      - wget
      - file
      - unzip
      - libwebkit2gtk-4.1-dev
      - libgtk-3-dev
      - libayatana-appindicator3-dev
      - librsvg2-dev
      - patchelf
      - build-essential
      - pkg-config
    stage-packages:
      - libwebkit2gtk-4.1-0
      - libgtk-3-0
      - libayatana-appindicator3-1
      - librsvg2-2
    override-build: |
      set -eux
      
      echo "=== Installing Bun ==="
      curl -fsSL https://bun.sh/install | bash
      export BUN_INSTALL="$HOME/.bun"
      export PATH="$BUN_INSTALL/bin:$PATH"
      bun --version
      
      echo "=== Installing Rust ==="
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
      export PATH="$HOME/.cargo/bin:$PATH"
      rustc --version
      cargo --version
      
      echo "=== Installing root dependencies ==="
      cd $CRAFT_PART_SRC
      bun install
      
      echo "=== Installing desktop dependencies ==="
      cd apps/desktop
      bun install
      
      echo "=== Building desktop frontend ==="
      bun run build
      
      # éªŒè¯æ„å»ºè¾“å‡º
      if [ ! -d "dist" ]; then
        echo "ERROR: Frontend build failed - dist directory not found"
        exit 1
      fi
      
      echo "=== Building Tauri application ==="
      # ä½¿ç”¨ bun è¿è¡Œ tauriï¼ˆä¼šè‡ªåŠ¨ä½¿ç”¨ node_modules ä¸­çš„ @tauri-apps/cliï¼‰
      bun run tauri build --bundles deb
      
      echo "=== Extracting deb package ==="
      DEB_FILE=$(find src-tauri/target/release/bundle/deb -name "*.deb" | head -n 1)
      if [ -z "$DEB_FILE" ]; then
        echo "ERROR: No deb file found"
        exit 1
      fi
      
      echo "Found deb: $DEB_FILE"
      dpkg-deb -x $DEB_FILE $CRAFT_PART_INSTALL
      
      echo "=== Setting up binary ==="
      mkdir -p $CRAFT_PART_INSTALL/bin
      
      # åˆ—å‡ºè§£å‹åçš„å†…å®¹ä»¥ä¾¿è°ƒè¯•
      echo "Contents of CRAFT_PART_INSTALL:"
      find $CRAFT_PART_INSTALL -type f -name "novel-editor*" 2>/dev/null || true
      
      # æŸ¥æ‰¾å¹¶å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä½¿ç”¨ cp è€Œé mvï¼Œæ›´å®‰å…¨ï¼‰
      BINARY_PATH=$(find $CRAFT_PART_INSTALL -type f -name "novel-editor" -executable | head -n 1)
      if [ -n "$BINARY_PATH" ]; then
        echo "Found binary at: $BINARY_PATH"
        cp "$BINARY_PATH" $CRAFT_PART_INSTALL/bin/novel-editor
        chmod +x $CRAFT_PART_INSTALL/bin/novel-editor
      else
        echo "ERROR: Binary not found, listing all files:"
        find $CRAFT_PART_INSTALL -type f
        exit 1
      fi
      
      echo "=== Verifying binary ==="
      ls -la $CRAFT_PART_INSTALL/bin/
      
      echo "=== Build completed successfully ==="
